-- This script was automatically @generated by Maui, it is not intended for manual editing.
local Constants = {
    KEY_LINK = "Key link not loaded! Please wait and try again.",
    WHITELIST_LINK = "Whitelist link not loaded! Please wait and try again.",
    DISCORD_INVITE = "https://dsc.gg/imphub"
}

local WINDOW_DEFAULT_SIZE = Vector2.new(800, 480)
local currentCamera = workspace.CurrentCamera
local playerScreenGui = script:WaitForChild("Player")
local resourcesFolder = script:WaitForChild("Resources")
local rendererPart = playerScreenGui.Renderer
local windowSurfaceGui = rendererPart.Surface

-- Update currentCamera when it changes
workspace:GetPropertyChangedSignal("CurrentCamera"):Connect(function()
    currentCamera = workspace.CurrentCamera
end)

local screenContainer = playerScreenGui.ScreenContainer
local hubPositionFrame = screenContainer.HubPosition
local keyFieldContainer = windowSurfaceGui.Window.Content.Login.LoginBox.LoginLayout.KeyField
local keyTextBox = keyFieldContainer.Key
local modalShade = windowSurfaceGui.Window.Modals
local colorPickerShade = windowSurfaceGui.Window.ColorModal
local homePageSidebar = windowSurfaceGui.Window.Content.Hub.MainContent.PageView.Home.Sidebar
local pageContentFrame = windowSurfaceGui.Window.Content.Hub.MainContent.PageView.Home.PageBase.PageContents
local subtitleLabel = windowSurfaceGui.Window.Content.TopBar.LogoTitle.Subtitle.SubText
local versionLabel = windowSurfaceGui.Window.Content.TopBar.LogoTitle.Subtitle.Version
local impThemeColors = resourcesFolder.Themes.Imp.Colors
local colorPickerWidget = colorPickerShade.ColorPickerUI
local basicColorPickerPanel = colorPickerWidget.Basic
local advancedColorPickerPanel = colorPickerWidget.Advanced
local colorPickerSubtitleLabel = colorPickerWidget.TopBar.Title.Subtitle
local minimizedTaskbarButton = playerScreenGui.MinimizedTask
local tweenService = game:GetService("TweenService")

local dialogQueue = {}
local isModalTransitioning = nil -- nil or Tween object
local toastShowQueue = {}
local activeToastsList = {} -- Toasts currently visible on screen
local toastApiObjects = {} -- Map toast Frame -> API object
local toastDurations = {} -- Map toast Frame -> duration for automatic closing

playerScreenGui.Parent = nil -- Detach from PlayerGui initially, will be parented to Renderer later

local tooltipContainer = windowSurfaceGui.Window.TooltipContainer
local hideTooltipTween = tweenService:Create(tooltipContainer, TweenInfo.new(0.5, Enum.EasingStyle.Quad, Enum.EasingDirection.In, 0, false, 0.5), { Size = UDim2.fromOffset(0) })
local tooltipTextBubble = tooltipContainer.Frame.TextBubble
local tooltipTextLabel = tooltipTextBubble.Label
local tooltipListLayout = tooltipTextBubble.UIListLayout
local tooltipTailContainer = tooltipTextBubble.Label.TailContainer
local tooltipTailLeftClip = tooltipTailContainer.TailLeftClip
local tooltipTailRightClip = tooltipTailContainer.TailRightClip
local tooltipTailLeftFrame = tooltipTailLeftClip.Frame
local tooltipTailRightFrame = tooltipTailRightClip.Frame
local currentTooltipElement = nil
local activeModalCount = 0

-- Bindable Events Setup
do
    local eventNames = { "LoginRequest", "MinimizedChanged", "SizeChanged", "Opened", "Closing", "HubDestroying", "WhitelistChanged" }
    for _, eventName in next, eventNames do
        local bindableEvent = Instance.new("BindableEvent")
        bindableEvent.Name = eventName
        bindableEvent.Parent = resourcesFolder.Bindables
    end
end

local publicApiTable -- Forward declaration for the main API table
local renderConnection

-- Renderer Part Positioning and Sizing
do
    local cframeOffset = CFrame.new(0, 0, -50)
    local dummyPart = Instance.new("Part")
    dummyPart.Size = Vector3.zero
    local localOffset = CFrame.new(0, 0, -dummyPart.Size.Z / 2)
    dummyPart:Destroy()
    dummyPart = nil

    local lastCameraCFrame
    local lastCameraFOV
    local lastHubPositionAbsoluteSize
    local lastHubPositionAbsolutePosition
    local cachedHubWorldPosition -- Stores the world position for the center of the hub UI
    
    renderConnection = game:GetService("RunService").PreRender:Connect(function()
        local cameraCFrame = currentCamera:GetRenderCFrame()

        if currentCamera.FieldOfView ~= lastCameraFOV or hubPositionFrame.AbsoluteSize ~= lastHubPositionAbsoluteSize or hubPositionFrame.AbsolutePosition ~= lastHubPositionAbsolutePosition then
            -- Recalculate UI size and position based on camera and screen GUI
            local inverseCameraTransform = cameraCFrame:ToObjectSpace(CFrame.new(cameraCFrame.Position)):Inverse()
            local targetPosition = (cameraCFrame * cframeOffset).Position
            local cameraLookVector = cameraCFrame.LookVector

            -- Adjust for odd/even absolute sizes for precise screen point to ray conversion
            local xPixelOffset = playerScreenGui.AbsoluteSize.X % 2 == 0 and 0 or 0.5
            local yPixelOffset = playerScreenGui.AbsoluteSize.Y % 2 == 0 and 0 or 0.5

            local rayTopLeft = currentCamera:ScreenPointToRay(hubPositionFrame.AbsolutePosition.X + xPixelOffset, hubPositionFrame.AbsolutePosition.Y + yPixelOffset, 0)
            local rayTopRight = currentCamera:ScreenPointToRay(hubPositionFrame.AbsolutePosition.X + hubPositionFrame.AbsoluteSize.X + xPixelOffset, hubPositionFrame.AbsolutePosition.Y + yPixelOffset, 0)
            local rayBottomLeft = currentCamera:ScreenPointToRay(hubPositionFrame.AbsolutePosition.X + xPixelOffset, hubPositionFrame.AbsolutePosition.Y + hubPositionFrame.AbsoluteSize.Y + yPixelOffset, 0)

            -- Intersect rays with the plane defined by the camera's look vector at targetPosition
            local pointTopLeft = rayTopLeft.Origin + rayTopLeft.Direction * (targetPosition - rayTopLeft.Origin):Dot(cameraLookVector) / rayTopLeft.Direction:Dot(cameraLookVector)
            local pointTopRight = rayTopRight.Origin + rayTopRight.Direction * (targetPosition - rayTopRight.Origin):Dot(cameraLookVector) / rayTopRight.Direction:Dot(cameraLookVector)
            local pointBottomLeft = rayBottomLeft.Origin + rayBottomLeft.Direction * (targetPosition - rayBottomLeft.Origin):Dot(cameraLookVector) / rayBottomLeft.Direction:Dot(cameraLookVector)

            rendererPart.Size = Vector3.new((pointTopRight - pointTopLeft).magnitude, (pointBottomLeft - pointTopLeft).magnitude, 0)
            cachedHubWorldPosition = cameraCFrame:PointToObjectSpace((pointBottomLeft + pointTopRight) / 2)
            rendererPart.CFrame = cameraCFrame * CFrame.new(cachedHubWorldPosition) * localOffset

            lastCameraFOV = currentCamera.FieldOfView
            lastHubPositionAbsoluteSize = hubPositionFrame.AbsoluteSize
        end

        -- Update CFrame if camera or hub position changes
        if cameraCFrame ~= lastCameraCFrame or hubPositionFrame.AbsolutePosition ~= lastHubPositionAbsolutePosition then
            rendererPart.CFrame = cameraCFrame * CFrame.new(cachedHubWorldPosition) * localOffset
            lastCameraCFrame = cameraCFrame
            lastHubPositionAbsolutePosition = hubPositionFrame.AbsolutePosition
        end

        -- Check if UI elements are valid, if not, trigger cleanup
        if not hubPositionFrame.Parent or not rendererPart.Parent or not windowSurfaceGui.Parent or not playerScreenGui.Parent then
            publicApiTable.HubDestroying:Fire() -- Notify API consumers
            cleanupGui() -- Call the cleanup function
        end
    end)
end

-- Coroutine to parent windowSurfaceGui to rendererPart after initial render frames
coroutine.resume(coroutine.create(function()
    game:GetService("RunService").PreRender:Wait()
    game:GetService("RunService").PreAnimation:Wait()
    windowSurfaceGui.Parent = nil
    windowSurfaceGui.Parent = rendererPart
end))

-- Tween setup
do
    local tweens = {
        GuiFull = tweenService:Create(hubPositionFrame, TweenInfo.new(0.2, Enum.EasingStyle.Quint), { Size = UDim2.fromScale(1, 1) }),
        GuiHalf = tweenService:Create(hubPositionFrame, TweenInfo.new(0.2, Enum.EasingStyle.Quint), { Size = UDim2.fromScale(0.5, 0.5) }),
        GuiEnterFull = tweenService:Create(hubPositionFrame, TweenInfo.new(), { Size = UDim2.fromScale(1, 1) }),
        GuiEnterHalf = tweenService:Create(hubPositionFrame, TweenInfo.new(), { Size = UDim2.fromScale(0.5, 0.5) }),
        GuiExit = tweenService:Create(hubPositionFrame, TweenInfo.new(), { Size = UDim2.fromOffset() }),
        CanvasFull = tweenService:Create(windowSurfaceGui, TweenInfo.new(), { CanvasSize = WINDOW_DEFAULT_SIZE }),
        CanvasMin = tweenService:Create(windowSurfaceGui, TweenInfo.new(), { CanvasSize = Vector2.zero }),
        AdvancedColorsEnter = tweenService:Create(colorPickerWidget, TweenInfo.new(0.5), { Size = UDim2.fromOffset(576, 384) }),
        AdvancedColorsExit = tweenService:Create(colorPickerWidget, TweenInfo.new(0.5), { Size = UDim2.fromOffset(384, 384) }),
        ModalShadeFadeIn = tweenService:Create(modalShade, TweenInfo.new(0.5), { BackgroundTransparency = 0.4 }),
        ModalShadeFadeOut = tweenService:Create(modalShade, TweenInfo.new(0.5), { BackgroundTransparency = 1 }),
        ColorModalShadeFadeIn = tweenService:Create(colorPickerShade, TweenInfo.new(0.5), { BackgroundTransparency = 0.4 }),
        ColorModalShadeFadeOut = tweenService:Create(colorPickerShade, TweenInfo.new(0.5), { BackgroundTransparency = 1 }),
        ColorPickerOpen = tweenService:Create(colorPickerWidget, TweenInfo.new(0.25), { Position = UDim2.fromScale(0.5, 0.5), AnchorPoint = Vector2.new(0.5, 0.5) }),
        ColorPickerClose = tweenService:Create(colorPickerWidget, TweenInfo.new(0.25), { Position = UDim2.fromScale(0.5, 1), AnchorPoint = Vector2.new(0.5) })
    }
    for name, tween in next, tweens do
        tween.Name = name
        tween.Parent = resourcesFolder.Tweens
    end
end

-- Executor Check
do
    local unsupportedExecutors = { solara = true }
    if identifyexecutor then
        local detectedExecutor = identifyexecutor()
        if unsupportedExecutors[detectedExecutor:lower()] then
            publicApiTable.Window:ShowDialog({
                Title = "Executor Unsupported!",
                Text = detectedExecutor .. " is not supported by our key system! Please use another executor.\nThis window will now close.",
                Buttons = { { Title = "OK", Callback = publicApiTable.Window.Close } }
            })
        end
    end
end

local loginBackground = windowSurfaceGui.Window.Content.Login.Background
local hubBackground = windowSurfaceGui.Window.Content.Hub.Background

-- Refresh background visibility on canvas size change (to fix rendering issues)
windowSurfaceGui:GetPropertyChangedSignal("CanvasSize"):Connect(function()
    loginBackground.Visible = false
    loginBackground.Visible = true
    hubBackground.Visible = false
    hubBackground.Visible = true
end)

-- Loading Screen Animation
game.TweenService:Create(windowSurfaceGui.Window.LoadingScreen.LoadingCircle.UIStroke.UIGradient, TweenInfo.new(1, Enum.EasingStyle.Linear, Enum.EasingDirection.Out, -1), { Rotation = 360 }):Play()

-- Day/Night Cycle for Login Background
local currentHour = os.date("*t").hour
if currentHour >= 6 and currentHour < 18 then
    loginBackground.SkyNight.Visible = false
    loginBackground.SkyDay.Visible = true
    loginBackground.GradientNight.Enabled = false
    loginBackground.GradientDay.Enabled = true
end

-- Global UI State Variables
local isHueDragging = false
local isValueDragging = false
local isMinimized = false
local isSmallWindow = false
local isWhitelistActive = false
local hubPositionBeforeMinimize
local lastTouchInput

local inputBeganConnection
local inputChangedConnection
local inputEndedConnection

-- Dragging, resizing, and slider logic
do
    local isWindowDragging = false
    local isMinimizedButtonDragging = false
    local inputPositionOnDragStart = Vector2.zero
    local isSliderDragging = false -- A slider knob is being dragged
    local activeSliderKnob = nil
    local sliderFillBar = nil
    local currentSliderValueObject = nil -- The BindableValue or similar object holding the slider's value
    local sliderKnobInitialPosition
    local sliderLiveValue
    local sliderMinValue
    local sliderMaxValue
    local sliderStepValue
    local isSliderPercentDisplay

    inputBeganConnection = game:GetService("UserInputService").InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            if not isSliderDragging then -- Only record start position if not currently dragging a slider
                inputPositionOnDragStart = input.Position
                lastTouchInput = input
            end
            if isWindowDragging then -- If was already dragging window, and new input is touch, set isSliderDragging true
                if input.UserInputType == Enum.UserInputType.Touch then
                    isSliderDragging = true
                end
            end
        end
    end)

    inputChangedConnection = game:GetService("UserInputService").InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or (input.UserInputType == Enum.UserInputType.Touch and input == lastTouchInput) then
            if isWindowDragging then
                screenContainer.Position = hubPositionBeforeMinimize + UDim2.fromOffset(input.Position.X - inputPositionOnDragStart.X, input.Position.Y - inputPositionOnDragStart.Y)
            elseif isMinimizedButtonDragging then
                minimizedTaskbarButton.Position = hubPositionBeforeMinimize + UDim2.fromOffset(input.Position.X - inputPositionOnDragStart.X, input.Position.Y - inputPositionOnDragStart.Y)
                isWindowDragging = false -- Reset window dragging flag
            elseif activeSliderKnob then -- If a slider knob is active/being dragged
                local parentFrame = activeSliderKnob.Parent
                local normalizedX = (inputPositionOnDragStart.X - parentFrame.AbsolutePosition.X) / parentFrame.AbsoluteSize.X
                local newNormalizedX = (input.Position.X - parentFrame.AbsolutePosition.X) / parentFrame.AbsoluteSize.X
                local newSliderValueNormalized = math.clamp(sliderKnobInitialPosition.X.Scale + (newNormalizedX - normalizedX), 0, 1)

                local actualSliderValue
                if sliderStepValue ~= math.huge and sliderStepValue ~= -math.huge then
                    -- Calculate value with stepping
                    local valueRange = (sliderMaxValue - sliderMinValue)
                    actualSliderValue = math.round((sliderMinValue + (newSliderValueNormalized * valueRange)) * sliderStepValue) / sliderStepValue
                    local scaledValueNormalized = UDim2.fromScale((actualSliderValue - sliderMinValue) / valueRange, 1)
                    activeSliderKnob.Position = scaledValueNormalized
                    sliderFillBar.Size = scaledValueNormalized
                    actualSliderValue = 1 / actualSliderValue ~= -math.huge and actualSliderValue or 0
                else
                    -- No stepping, direct value
                    actualSliderValue = sliderMinValue + (newSliderValueNormalized * (sliderMaxValue - sliderMinValue))
                    activeSliderKnob.Position = UDim2.fromScale(newSliderValueNormalized, 0.5)
                    sliderFillBar.Size = UDim2.fromScale(newNormalizedX, 1)
                end
                actualSliderValue = math.clamp(actualSliderValue, sliderMinValue, sliderMaxValue)

                tooltipTextLabel.Text = isSliderPercentDisplay and math.round(100 * actualSliderValue) .. "%" or actualSliderValue
                local tooltipCurrentSize = tooltipTextBubble.AbsoluteSize
                tooltipContainer.Size = UDim2.fromOffset(tooltipCurrentSize.X, tooltipCurrentSize.Y)

                if currentSliderValueObject.Value ~= actualSliderValue then
                    currentSliderValueObject.Value = actualSliderValue
                    local onChangedCallback = currentSliderValueObject.OnChanged
                    if typeof(onChangedCallback) == "function" then
                        coroutine.resume(coroutine.create(onChangedCallback), actualSliderValue)
                    end
                end
            end
        end
    end)

    inputEndedConnection = game:GetService("UserInputService").InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or (input.UserInputType == Enum.UserInputType.Touch and input == lastTouchInput) then
            isWindowDragging = false
            isMinimizedButtonDragging = false
            isHueDragging = false -- Reset color picker hue dragging (reused variable from earlier)
            isValueDragging = false -- Reset color picker value dragging (reused variable from earlier)

            if activeSliderKnob then
                if currentTooltipElement ~= activeSliderKnob then
                    hideTooltipTween:Play()
                end
                activeSliderKnob = nil
                currentSliderValueObject = nil
            end
            if input == lastTouchInput then
                isSliderDragging = false -- Reset global slider dragging flag
            end
        end
    end)

    windowSurfaceGui.Window.Content.TopBar.WindowGrip.MouseButton1Down:Connect(function(_)
        hubPositionBeforeMinimize = screenContainer.Position
        isWindowDragging = true
    end)

    windowSurfaceGui.Window.Content.TopBar.WindowGrip.MouseButton1Up:Connect(function(_)
        isWindowDragging = false
    end)

    -- Minimized Task Button Logic
    windowSurfaceGui.Window.Content.TopBar.LogoTitle.LogoContainer.Logo:Clone().Parent = minimizedTaskbarButton
    minimizedTaskbarButton.MouseButton1Down:Connect(function(_)
        hubPositionBeforeMinimize = minimizedTaskbarButton.Position
        isMinimizedButtonDragging = true
        isWindowDragging = true -- Keep track that a dragging action *started* from the minimized button
    end)
    minimizedTaskbarButton.MouseButton1Up:Connect(function(_)
        isMinimizedButtonDragging = false
        if isWindowDragging then -- If mouse up happened without moving, it's a click
            isMinimized = false
            minimizedTaskbarButton.Visible = false
            screenContainer.Position = UDim2.fromOffset(minimizedTaskbarButton.AbsolutePosition.X + minimizedTaskbarButton.AbsoluteSize.X / 2, minimizedTaskbarButton.AbsolutePosition.Y + minimizedTaskbarButton.AbsoluteSize.Y / 2)
            tweenService:Create(screenContainer, TweenInfo.new(), { Position = hubPositionBeforeMinimize }):Play()
            local hubSizeTween
            if isSmallWindow then
                hubSizeTween = resourcesFolder.Tweens.GuiHalf
            else
                hubSizeTween = resourcesFolder.Tweens.GuiFull
            end
            hubSizeTween:Play()
            resourcesFolder.Tweens.CanvasFull:Play()
            publicApiTable.Window.IsMinimized = false
            resourcesFolder.Bindables.MinimizedChanged:Fire(false)
        end
    end)
end

minimizedTaskbarButton.TouchTap:Connect(function()
    isMinimized = false
    minimizedTaskbarButton.Visible = false
    screenContainer.Position = UDim2.fromOffset(minimizedTaskbarButton.AbsolutePosition.X + minimizedTaskbarButton.AbsoluteSize.X / 2, minimizedTaskbarButton.AbsolutePosition.Y + minimizedTaskbarButton.AbsoluteSize.Y / 2)
    tweenService:Create(screenContainer, TweenInfo.new(), { Position = hubPositionBeforeMinimize }):Play()
    if isSmallWindow then
        resourcesFolder.Tweens.GuiHalf:Play()
    else
        resourcesFolder.Tweens.GuiFull:Play()
    end
    resourcesFolder.Tweens.CanvasFull:Play()
    publicApiTable.Window.IsMinimized = false
    resourcesFolder.Bindables.MinimizedChanged:Fire(false)
end)

windowSurfaceGui.Window.Content.TopBar.WindowControls.Maximize.MouseButton1Click:Connect(function()
    isSmallWindow = not isSmallWindow
    if isSmallWindow then
        resourcesFolder.Tweens.GuiHalf:Play()
    else
        resourcesFolder.Tweens.GuiFull:Play()
    end
    publicApiTable.Window.IsSmall = isSmallWindow
    resourcesFolder.Bindables.SizeChanged:Fire(isSmallWindow)
end)

windowSurfaceGui.Window.Content.TopBar.WindowControls.Minimize.MouseButton1Click:Connect(function()
    isMinimized = true
    hubPositionBeforeMinimize = screenContainer.Position
    local minimizeTween = resourcesFolder.Tweens.GuiExit
    tweenService:Create(screenContainer, TweenInfo.new(), { Position = UDim2.fromOffset(minimizedTaskbarButton.AbsolutePosition.X + minimizedTaskbarButton.AbsoluteSize.X / 2, minimizedTaskbarButton.AbsolutePosition.Y + minimizedTaskbarButton.AbsoluteSize.Y / 2) }):Play()
    resourcesFolder.Tweens.CanvasMin:Play()
    minimizeTween:Play()
    publicApiTable.Window.IsMinimized = true
    resourcesFolder.Bindables.MinimizedChanged:Fire(true)
    minimizeTween.Completed:Once(function()
        minimizedTaskbarButton.Visible = true
    end)
end)

windowSurfaceGui.Window.Content.TopBar.WindowControls.Close.MouseButton1Click:Connect(function()
    publicApiTable.Window:ShowDialog({
        Title = "Close Imp Hub?",
        Text = "This will close Imp Hub, cleaning up everything. You won't be able to access it again unless you run it from your executor. Continue?",
        Buttons = { { Title = "OK", Callback = publicApiTable.Window.Close, Secondary = true }, { Title = "Cancel" } }
    })
end)

windowSurfaceGui.Window.Content.Login.LoginBox.CTAContainer.Help.MouseButton1Click:Connect(function()
    publicApiTable.Window:ShowDialog({
        Title = "Need help?",
        Text = "If you are experiencing problems logging in, you may feel free to join our Discord server for support.",
        CopyBoxText = Constants.DISCORD_INVITE
    })
end)

windowSurfaceGui.Window.Content.Login.LoginBox.CTAContainer.GetKey.MouseButton1Click:Connect(function()
    publicApiTable.Window:ShowDialog({
        Title = "Get Key",
        Text = "To get a key for Imp Hub, please visit the following URL below in your web browser. You will see ads which support us and help us to make more scripts. Thanks for your support!",
        CopyBoxText = isWhitelistActive and Constants.WHITELIST_LINK or Constants.KEY_LINK
    })
end)

windowSurfaceGui.Window.Content.Login.LoginBox.LoginLayout.LogIn.MouseButton1Click:Connect(function()
    local onLoginCallback = publicApiTable.Login.OnLogin
    onLoginCallback = typeof(onLoginCallback) == "function" and onLoginCallback or nil
    local keyText = not isWhitelistActive and keyTextBox.Text or nil
    if onLoginCallback then
        coroutine.resume(coroutine.create(onLoginCallback), keyText)
    end
    resourcesFolder.Bindables.LoginRequest:Fire(keyText)
end)

windowSurfaceGui.Window.Content.Login.DiscordButton.MouseButton1Click:Connect(function()
    publicApiTable.Window:ShowDialog({
        Title = "Join our Discord server!",
        Text = "To recieve support, purchase keys, and chat with our community, feel free to join the server below!",
        CopyBoxText = Constants.DISCORD_INVITE
    })
end)

local currentlyFocusedTextBox

game:GetService("UserInputService").TextBoxFocused:Connect(function(textBox)
    currentlyFocusedTextBox = textBox
end)
game:GetService("UserInputService").TextBoxFocusReleased:Connect(function(textBox)
    currentlyFocusedTextBox = nil
end)

-- Color Picker Logic
local selectedColor = Color3.fromHSV(1, 1, 1)
local targetColorPropertyObject -- Object that holds the color value for the element that opened the picker
local hsvHue, hsvSaturation, hsvValue = selectedColor:ToHSV()

local hueColorPad = advancedColorPickerPanel.AdvancedColors.ColorPads.ColorProf.Hue
local valueLightnessPad = advancedColorPickerPanel.AdvancedColors.ColorPads.ValueProf.Light
local colorPreviewSwatch = advancedColorPickerPanel.AdvancedColors.FineTuning.ColorPreview.Color
local hueCursor = hueColorPad.Cursor
local valueArrow = valueLightnessPad.ArrowTrack.Arrow
local fineTuneValueTextBoxes = advancedColorPickerPanel.AdvancedColors.FineTuning.FineTuneVals

local fineTuneTextBoxCurrentValues = {
    [fineTuneValueTextBoxes.Hue.TextBox] = fineTuneValueTextBoxes.Hue.TextBox.Text,
    [fineTuneValueTextBoxes.Sat.TextBox] = fineTuneValueTextBoxes.Sat.TextBox.Text,
    [fineTuneValueTextBoxes.Val.TextBox] = fineTuneValueTextBoxes.Val.TextBox.Text,
    [fineTuneValueTextBoxes.R.TextBox] = fineTuneValueTextBoxes.R.TextBox.Text,
    [fineTuneValueTextBoxes.G.TextBox] = fineTuneValueTextBoxes.G.TextBox.Text,
    [fineTuneValueTextBoxes.B.TextBox] = fineTuneValueTextBoxes.B.TextBox.Text,
    [fineTuneValueTextBoxes.Hex.TextBox] = fineTuneValueTextBoxes.Hex.TextBox.Text
}

local fineTuneTextBoxCursorPositions = {
    [fineTuneValueTextBoxes.Hue.TextBox] = fineTuneValueTextBoxes.Hue.TextBox.CursorPosition,
    [fineTuneValueTextBoxes.Sat.TextBox] = fineTuneValueTextBoxes.Sat.TextBox.CursorPosition,
    [fineTuneValueTextBoxes.Val.TextBox] = fineTuneValueTextBoxes.Val.TextBox.CursorPosition,
    [fineTuneValueTextBoxes.R.TextBox] = fineTuneValueTextBoxes.R.TextBox.CursorPosition,
    [fineTuneValueTextBoxes.G.TextBox] = fineTuneValueTextBoxes.G.TextBox.CursorPosition,
    [fineTuneValueTextBoxes.B.TextBox] = fineTuneValueTextBoxes.B.TextBox.CursorPosition,
    [fineTuneValueTextBoxes.Hex.TextBox] = fineTuneValueTextBoxes.Hex.TextBox.CursorPosition
}

local fineTuneTextBoxSelectionStarts = {
    [fineTuneValueTextBoxes.Hue.TextBox] = fineTuneValueTextBoxes.Hue.TextBox.SelectionStart,
    [fineTuneValueTextBoxes.Sat.TextBox] = fineTuneValueTextBoxes.Sat.TextBox.SelectionStart,
    [fineTuneValueTextBoxes.Val.TextBox] = fineTuneValueTextBoxes.Val.TextBox.SelectionStart,
    [fineTuneValueTextBoxes.R.TextBox] = fineTuneValueTextBoxes.R.TextBox.SelectionStart,
    [fineTuneValueTextBoxes.G.TextBox] = fineTuneValueTextBoxes.G.TextBox.SelectionStart,
    [fineTuneValueTextBoxes.B.TextBox] = fineTuneValueTextBoxes.B.TextBox.SelectionStart,
    [fineTuneValueTextBoxes.Hex.TextBox] = fineTuneValueTextBoxes.Hex.TextBox.SelectionStart
}

hueColorPad.Parent.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        local normalizedPosition = ((Vector2.new(input.Position.X, input.Position.Y) - hueColorPad.AbsolutePosition) / hueColorPad.AbsoluteSize):Max(Vector2.zero):Min(Vector2.one)
        local hueValueInt = math.floor(normalizedPosition.X * 359)
        local satValueInt = math.floor(normalizedPosition.Y * 255)

        hsvHue = (359 - hueValueInt) / 360
        hsvSaturation = 1 - satValueInt / 255
        selectedColor = Color3.fromHSV(hsvHue, hsvSaturation, hsvValue)

        fineTuneValueTextBoxes.Hue.TextBox.Text = 359 - hueValueInt
        fineTuneValueTextBoxes.Sat.TextBox.Text = 255 - satValueInt
        fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.Hue.TextBox] = fineTuneValueTextBoxes.Hue.TextBox.Text
        fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.Sat.TextBox] = fineTuneValueTextBoxes.Sat.TextBox.Text

        local hexColor = selectedColor:ToHex()
        fineTuneValueTextBoxes.Hex.TextBox.Text = "#" .. hexColor
        fineTuneValueTextBoxes.R.TextBox.Text = tonumber(hexColor:sub(1, 2), 16)
        fineTuneValueTextBoxes.G.TextBox.Text = tonumber(hexColor:sub(3, 4), 16)
        fineTuneValueTextBoxes.B.TextBox.Text = tonumber(hexColor:sub(5, 6), 16)
        fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.Hex.TextBox] = fineTuneValueTextBoxes.Hex.TextBox.Text
        fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.R.TextBox] = fineTuneValueTextBoxes.R.TextBox.Text
        fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.G.TextBox] = fineTuneValueTextBoxes.G.TextBox.Text
        fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.B.TextBox] = fineTuneValueTextBoxes.B.TextBox.Text

        hueCursor.Position = UDim2.fromScale(hueValueInt / 359, satValueInt / 255)
        colorPreviewSwatch.BackgroundColor3 = selectedColor
        valueLightnessPad.BackgroundColor3 = Color3.fromHSV(hsvHue, hsvSaturation, 1)
        isHueDragging = true
    end
end)

valueLightnessPad.Parent.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        local normalizedY = math.floor(math.clamp((input.Position.Y - valueLightnessPad.AbsolutePosition.Y) / valueLightnessPad.AbsoluteSize.Y, 0, 1) * 255)
        hsvValue = 1 - normalizedY / 255
        selectedColor = Color3.fromHSV(hsvHue, hsvSaturation, hsvValue)
        fineTuneValueTextBoxes.Val.TextBox.Text = 255 - normalizedY
        fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.Val.TextBox] = fineTuneValueTextBoxes.Val.TextBox.Text

        local hexColor = selectedColor:ToHex()
        fineTuneValueTextBoxes.Hex.TextBox.Text = "#" .. hexColor
        fineTuneValueTextBoxes.R.TextBox.Text = tonumber(hexColor:sub(1, 2), 16)
        fineTuneValueTextBoxes.G.TextBox.Text = tonumber(hexColor:sub(3, 4), 16)
        fineTuneValueTextBoxes.B.TextBox.Text = tonumber(hexColor:sub(5, 6), 16)
        fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.Hex.TextBox] = fineTuneValueTextBoxes.Hex.TextBox.Text
        fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.R.TextBox] = fineTuneValueTextBoxes.R.TextBox.Text
        fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.G.TextBox] = fineTuneValueTextBoxes.G.TextBox.Text
        fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.B.TextBox] = fineTuneValueTextBoxes.B.TextBox.Text

        valueArrow.Position = UDim2.fromScale(0, normalizedY / 255)
        colorPreviewSwatch.BackgroundColor3 = selectedColor
        isValueDragging = true
    end
end)

hueColorPad.Parent.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement or (input.UserInputType == Enum.UserInputType.Touch and input == lastTouchInput) then
        if isHueDragging then
            local normalizedPosition = ((Vector2.new(input.Position.X, input.Position.Y) - hueColorPad.AbsolutePosition) / hueColorPad.AbsoluteSize):Max(Vector2.zero):Min(Vector2.one)
            local hueValueInt = math.floor(normalizedPosition.X * 359)
            local satValueInt = math.floor(normalizedPosition.Y * 255)

            hsvHue = (359 - hueValueInt) / 360
            hsvSaturation = 1 - satValueInt / 255
            selectedColor = Color3.fromHSV(hsvHue, hsvSaturation, hsvValue)

            fineTuneValueTextBoxes.Hue.TextBox.Text = 359 - hueValueInt
            fineTuneValueTextBoxes.Sat.TextBox.Text = 255 - satValueInt
            fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.Hue.TextBox] = fineTuneValueTextBoxes.Hue.TextBox.Text
            fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.Sat.TextBox] = fineTuneValueTextBoxes.Sat.TextBox.Text

            local hexColor = selectedColor:ToHex()
            fineTuneValueTextBoxes.Hex.TextBox.Text = "#" .. hexColor
            fineTuneValueTextBoxes.R.TextBox.Text = tonumber(hexColor:sub(1, 2), 16)
            fineTuneValueTextBoxes.G.TextBox.Text = tonumber(hexColor:sub(3, 4), 16)
            fineTuneValueTextBoxes.B.TextBox.Text = tonumber(hexColor:sub(5, 6), 16)
            fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.Hex.TextBox] = fineTuneValueTextBoxes.Hex.TextBox.Text
            fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.R.TextBox] = fineTuneValueTextBoxes.R.TextBox.Text
            fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.G.TextBox] = fineTuneValueTextBoxes.G.TextBox.Text
            fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.B.TextBox] = fineTuneValueTextBoxes.B.TextBox.Text

            hueCursor.Position = UDim2.fromScale(hueValueInt / 359, satValueInt / 255)
            colorPreviewSwatch.BackgroundColor3 = selectedColor
            valueLightnessPad.BackgroundColor3 = Color3.fromHSV(hsvHue, hsvSaturation, 1)
        end
    end
end)

valueLightnessPad.Parent.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement or (input.UserInputType == Enum.UserInputType.Touch and input == lastTouchInput) then
        if isValueDragging then
            local normalizedY = math.floor(math.clamp((input.Position.Y - valueLightnessPad.AbsolutePosition.Y) / valueLightnessPad.AbsoluteSize.Y, 0, 1) * 255)
            hsvValue = 1 - normalizedY / 255
            selectedColor = Color3.fromHSV(hsvHue, hsvSaturation, hsvValue)
            fineTuneValueTextBoxes.Val.TextBox.Text = 255 - normalizedY
            fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.Val.TextBox] = fineTuneValueTextBoxes.Val.TextBox.Text

            local hexColor = selectedColor:ToHex()
            fineTuneValueTextBoxes.Hex.TextBox.Text = "#" .. hexColor
            fineTuneValueTextBoxes.R.TextBox.Text = tonumber(hexColor:sub(1, 2), 16)
            fineTuneValueTextBoxes.G.TextBox.Text = tonumber(hexColor:sub(3, 4), 16)
            fineTuneValueTextBoxes.B.TextBox.Text = tonumber(hexColor:sub(5, 6), 16)
            fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.Hex.TextBox] = fineTuneValueTextBoxes.Hex.TextBox.Text
            fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.R.TextBox] = fineTuneValueTextBoxes.R.TextBox.Text
            fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.G.TextBox] = fineTuneValueTextBoxes.G.TextBox.Text
            fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.B.TextBox] = fineTuneValueTextBoxes.B.TextBox.Text

            valueArrow.Position = UDim2.fromScale(0, normalizedY / 255)
            colorPreviewSwatch.BackgroundColor3 = selectedColor
        end
    end
end)

-- TextBox Cursor/Selection position saving
for _, textBox in pairs(fineTuneTextBoxCurrentValues) do
    if textBox == fineTuneValueTextBoxes.Hue.TextBox then
        fineTuneValueTextBoxes.Hue.TextBox:GetPropertyChangedSignal("CursorPosition"):Connect(function()
            local text = fineTuneValueTextBoxes.Hue.TextBox.Text
            if text == "" or (not text:match("%D") and tonumber(text) < 359) then
                fineTuneTextBoxCursorPositions[fineTuneValueTextBoxes.Hue.TextBox] = fineTuneValueTextBoxes.Hue.TextBox.CursorPosition
            end
        end)
        fineTuneValueTextBoxes.Hue.TextBox:GetPropertyChangedSignal("SelectionStart"):Connect(function()
            local text = fineTuneValueTextBoxes.Hue.TextBox.Text
            if text == "" or (not text:match("%D") and tonumber(text) < 359) then
                fineTuneTextBoxSelectionStarts[fineTuneValueTextBoxes.Hue.TextBox] = fineTuneValueTextBoxes.Hue.TextBox.SelectionStart
            end
        end)
    elseif textBox == fineTuneValueTextBoxes.Hex.TextBox then
        fineTuneValueTextBoxes.Hex.TextBox:GetPropertyChangedSignal("CursorPosition"):Connect(function()
            local text = fineTuneValueTextBoxes.Hex.TextBox.Text
            if text == "" or (string.sub(text, 1, 1) == "#" and not string.sub(text, 2):match("%X") and #text < 8) then
                fineTuneTextBoxCursorPositions[fineTuneValueTextBoxes.Hex.TextBox] = fineTuneValueTextBoxes.Hex.TextBox.CursorPosition
            end
        end)
        fineTuneValueTextBoxes.Hex.TextBox:GetPropertyChangedSignal("SelectionStart"):Connect(function()
            local text = fineTuneValueTextBoxes.Hex.TextBox.Text
            if text == "" or (string.sub(text, 1, 1) == "#" and not string.sub(text, 2):match("%X") and #text < 8) then
                fineTuneTextBoxSelectionStarts[fineTuneValueTextBoxes.Hex.TextBox] = fineTuneValueTextBoxes.Hex.TextBox.SelectionStart
            end
        end)
    else
        textBox:GetPropertyChangedSignal("CursorPosition"):Connect(function()
            local text = textBox.Text
            if text == "" or (not text:match("%D") and tonumber(text) < 256) then
                fineTuneTextBoxCursorPositions[textBox] = textBox.CursorPosition
            end
        end)
        textBox:GetPropertyChangedSignal("SelectionStart"):Connect(function()
            local text = textBox.Text
            if text == "" or (not text:match("%D") and tonumber(text) < 256) then
                fineTuneTextBoxSelectionStarts[textBox] = textBox.SelectionStart
            end
        end)
    end
end

-- TextBox Text change handling for Fine Tuning
for textBox, _ in pairs(fineTuneTextBoxCurrentValues) do
    if textBox == fineTuneValueTextBoxes.Hue.TextBox then
        textBox:GetPropertyChangedSignal("Text"):Connect(function()
            if currentlyFocusedTextBox == textBox then
                local newText = textBox.Text
                if newText == "" or (not newText:match("%D") and tonumber(newText) < 360) then
                    fineTuneTextBoxCurrentValues[textBox] = newText
                    if newText ~= "" then
                        hsvHue = tonumber(newText) / 360
                        local hexColor = Color3.fromHSV(hsvHue, hsvSaturation, hsvValue):ToHex()
                        selectedColor = Color3.fromHex(hexColor)
                        fineTuneValueTextBoxes.Hex.TextBox.Text = "#" .. hexColor
                        fineTuneValueTextBoxes.R.TextBox.Text = tonumber(hexColor:sub(1, 2), 16)
                        fineTuneValueTextBoxes.G.TextBox.Text = tonumber(hexColor:sub(3, 4), 16)
                        fineTuneValueTextBoxes.B.TextBox.Text = tonumber(hexColor:sub(5, 6), 16)
                        fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.Hex.TextBox] = fineTuneValueTextBoxes.Hex.TextBox.Text
                        fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.R.TextBox] = fineTuneValueTextBoxes.R.TextBox.Text
                        fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.G.TextBox] = fineTuneValueTextBoxes.G.TextBox.Text
                        fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.B.TextBox] = fineTuneValueTextBoxes.B.TextBox.Text
                        hueCursor.Position = UDim2.fromScale(1 - tonumber(newText) / 359, 1 - hsvSaturation)
                        colorPreviewSwatch.BackgroundColor3 = selectedColor
                        valueLightnessPad.BackgroundColor3 = Color3.fromHSV(hsvHue, hsvSaturation, 1)
                    end
                else
                    textBox.Text = fineTuneTextBoxCurrentValues[textBox]
                    textBox.CursorPosition = fineTuneTextBoxCursorPositions[textBox]
                    textBox.SelectionStart = fineTuneTextBoxSelectionStarts[textBox]
                end
            end
        end)
    elseif textBox == fineTuneValueTextBoxes.Sat.TextBox then
        textBox:GetPropertyChangedSignal("Text"):Connect(function()
            if currentlyFocusedTextBox == textBox then
                local newText = textBox.Text
                if newText == "" or (not newText:match("%D") and tonumber(newText) < 256) then
                    fineTuneTextBoxCurrentValues[textBox] = newText
                    if newText ~= "" then
                        hsvSaturation = tonumber(newText) / 255
                        local hexColor = Color3.fromHSV(hsvHue, hsvSaturation, hsvValue):ToHex()
                        selectedColor = Color3.fromHex(hexColor)
                        fineTuneValueTextBoxes.Hex.TextBox.Text = "#" .. hexColor
                        fineTuneValueTextBoxes.R.TextBox.Text = tonumber(hexColor:sub(1, 2), 16)
                        fineTuneValueTextBoxes.G.TextBox.Text = tonumber(hexColor:sub(3, 4), 16)
                        fineTuneValueTextBoxes.B.TextBox.Text = tonumber(hexColor:sub(5, 6), 16)
                        fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.Hex.TextBox] = fineTuneValueTextBoxes.Hex.TextBox.Text
                        fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.R.TextBox] = fineTuneValueTextBoxes.R.TextBox.Text
                        fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.G.TextBox] = fineTuneValueTextBoxes.G.TextBox.Text
                        fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.B.TextBox] = fineTuneValueTextBoxes.B.TextBox.Text
                        hueCursor.Position = UDim2.fromScale(1 - hsvHue, 1 - hsvSaturation)
                        colorPreviewSwatch.BackgroundColor3 = selectedColor
                        valueLightnessPad.BackgroundColor3 = Color3.fromHSV(hsvHue, hsvSaturation, 1)
                    end
                else
                    textBox.Text = fineTuneTextBoxCurrentValues[textBox]
                    textBox.CursorPosition = fineTuneTextBoxCursorPositions[textBox]
                    textBox.SelectionStart = fineTuneTextBoxSelectionStarts[textBox]
                end
            end
        end)
    elseif textBox == fineTuneValueTextBoxes.Val.TextBox then
        textBox:GetPropertyChangedSignal("Text"):Connect(function()
            if currentlyFocusedTextBox == textBox then
                local newText = textBox.Text
                if newText == "" or (not newText:match("%D") and tonumber(newText) < 256) then
                    fineTuneTextBoxCurrentValues[textBox] = newText
                    if newText ~= "" then
                        hsvValue = tonumber(newText) / 255
                        local hexColor = Color3.fromHSV(hsvHue, hsvSaturation, hsvValue):ToHex()
                        selectedColor = Color3.fromHex(hexColor)
                        fineTuneValueTextBoxes.Hex.TextBox.Text = "#" .. hexColor
                        fineTuneValueTextBoxes.R.TextBox.Text = tonumber(hexColor:sub(1, 2), 16)
                        fineTuneValueTextBoxes.G.TextBox.Text = tonumber(hexColor:sub(3, 4), 16)
                        fineTuneValueTextBoxes.B.TextBox.Text = tonumber(hexColor:sub(5, 6), 16)
                        fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.Hex.TextBox] = fineTuneValueTextBoxes.Hex.TextBox.Text
                        fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.R.TextBox] = fineTuneValueTextBoxes.R.TextBox.Text
                        fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.G.TextBox] = fineTuneValueTextBoxes.G.TextBox.Text
                        fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.B.TextBox] = fineTuneValueTextBoxes.B.TextBox.Text
                        valueArrow.Position = UDim2.fromScale(0, 1 - hsvValue)
                        colorPreviewSwatch.BackgroundColor3 = selectedColor
                    end
                else
                    textBox.Text = fineTuneTextBoxCurrentValues[textBox]
                    textBox.CursorPosition = fineTuneTextBoxCursorPositions[textBox]
                    textBox.SelectionStart = fineTuneTextBoxSelectionStarts[textBox]
                end
            end
        end)
    elseif textBox == fineTuneValueTextBoxes.R.TextBox then
        textBox:GetPropertyChangedSignal("Text"):Connect(function()
            if currentlyFocusedTextBox == textBox then
                local newText = textBox.Text
                if newText == "" or (not newText:match("%D") and tonumber(newText) < 256) then
                    fineTuneTextBoxCurrentValues[textBox] = newText
                    if newText ~= "" then
                        local newRed = tonumber(newText)
                        selectedColor = Color3.new(newRed / 255, selectedColor.G, selectedColor.B)

                        -- RGB to HSV Conversion
                        local r = math.floor(selectedColor.R * 255)
                        local g = math.floor(selectedColor.G * 255)
                        local b = math.floor(selectedColor.B * 255)

                        local maxVal, minVal = math.max(r, g, b), math.min(r, g, b)
                        local h, s, v
                        v = maxVal
                        local delta = maxVal - minVal
                        if maxVal == 0 then
                            s = 0
                        else
                            s = (delta * 255) / maxVal
                        end

                        if maxVal == minVal then
                            h = 0
                        else
                            if maxVal == r then
                                h = ((g - b) * 60) / delta
                                if g < b then h = h + 360 end
                            elseif maxVal == g then
                                h = ((b - r) * 60) / delta + 120
                            elseif maxVal == b then
                                h = ((r - g) * 60) / delta + 240
                            end
                        end
                        hsvHue, hsvSaturation, hsvValue = h / 360, s / 255, v / 255

                        local hexColor = selectedColor:ToHex()
                        fineTuneValueTextBoxes.Hex.TextBox.Text = "#" .. hexColor
                        fineTuneValueTextBoxes.Hue.TextBox.Text = math.floor(h)
                        fineTuneValueTextBoxes.Sat.TextBox.Text = math.round(s)
                        fineTuneValueTextBoxes.Val.TextBox.Text = math.round(v)

                        fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.Hex.TextBox] = fineTuneValueTextBoxes.Hex.TextBox.Text
                        fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.Hue.TextBox] = fineTuneValueTextBoxes.Hue.TextBox.Text
                        fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.Sat.TextBox] = fineTuneValueTextBoxes.Sat.TextBox.Text
                        fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.Val.TextBox] = fineTuneValueTextBoxes.Val.TextBox.Text

                        hueCursor.Position = UDim2.fromScale(1 - h / 359, 1 - hsvSaturation)
                        valueArrow.Position = UDim2.fromScale(0, 1 - hsvValue)
                        colorPreviewSwatch.BackgroundColor3 = selectedColor
                        valueLightnessPad.BackgroundColor3 = Color3.fromHSV(hsvHue, hsvSaturation, 1)
                    end
                else
                    textBox.Text = fineTuneTextBoxCurrentValues[textBox]
                    textBox.CursorPosition = fineTuneTextBoxCursorPositions[textBox]
                    textBox.SelectionStart = fineTuneTextBoxSelectionStarts[textBox]
                end
            end
        end)
    elseif textBox == fineTuneValueTextBoxes.G.TextBox then
        textBox:GetPropertyChangedSignal("Text"):Connect(function()
            if currentlyFocusedTextBox == textBox then
                local newText = textBox.Text
                if newText == "" or (not newText:match("%D") and tonumber(newText) < 256) then
                    fineTuneTextBoxCurrentValues[textBox] = newText
                    if newText ~= "" then
                        local newGreen = tonumber(newText)
                        selectedColor = Color3.new(selectedColor.R, newGreen / 255, selectedColor.B)

                        -- RGB to HSV Conversion
                        local r = math.floor(selectedColor.R * 255)
                        local g = math.floor(selectedColor.G * 255)
                        local b = math.floor(selectedColor.B * 255)

                        local maxVal, minVal = math.max(r, g, b), math.min(r, g, b)
                        local h, s, v
                        v = maxVal
                        local delta = maxVal - minVal
                        if maxVal == 0 then
                            s = 0
                        else
                            s = (delta * 255) / maxVal
                        end

                        if maxVal == minVal then
                            h = 0
                        else
                            if maxVal == r then
                                h = ((g - b) * 60) / delta
                                if g < b then h = h + 360 end
                            elseif maxVal == g then
                                h = ((b - r) * 60) / delta + 120
                            elseif maxVal == b then
                                h = ((r - g) * 60) / delta + 240
                            end
                        end
                        hsvHue, hsvSaturation, hsvValue = h / 360, s / 255, v / 255

                        local hexColor = selectedColor:ToHex()
                        fineTuneValueTextBoxes.Hex.TextBox.Text = "#" .. hexColor
                        fineTuneValueTextBoxes.Hue.TextBox.Text = math.floor(h)
                        fineTuneValueTextBoxes.Sat.TextBox.Text = math.round(s)
                        fineTuneValueTextBoxes.Val.TextBox.Text = math.round(v)

                        fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.Hex.TextBox] = fineTuneValueTextBoxes.Hex.TextBox.Text
                        fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.Hue.TextBox] = fineTuneValueTextBoxes.Hue.TextBox.Text
                        fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.Sat.TextBox] = fineTuneValueTextBoxes.Sat.TextBox.Text
                        fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.Val.TextBox] = fineTuneValueTextBoxes.Val.TextBox.Text

                        hueCursor.Position = UDim2.fromScale(1 - h / 359, 1 - hsvSaturation)
                        valueArrow.Position = UDim2.fromScale(0, 1 - hsvValue)
                        colorPreviewSwatch.BackgroundColor3 = selectedColor
                        valueLightnessPad.BackgroundColor3 = Color3.fromHSV(hsvHue, hsvSaturation, 1)
                    end
                else
                    textBox.Text = fineTuneTextBoxCurrentValues[textBox]
                    textBox.CursorPosition = fineTuneTextBoxCursorPositions[textBox]
                    textBox.SelectionStart = fineTuneTextBoxSelectionStarts[textBox]
                end
            end
        end)
    elseif textBox == fineTuneValueTextBoxes.B.TextBox then
        textBox:GetPropertyChangedSignal("Text"):Connect(function()
            if currentlyFocusedTextBox == textBox then
                local newText = textBox.Text
                if newText == "" or (not newText:match("%D") and tonumber(newText) < 256) then
                    fineTuneTextBoxCurrentValues[textBox] = newText
                    if newText ~= "" then
                        local newBlue = tonumber(newText)
                        selectedColor = Color3.new(selectedColor.R, selectedColor.G, newBlue / 255)

                        -- RGB to HSV Conversion
                        local r = math.floor(selectedColor.R * 255)
                        local g = math.floor(selectedColor.G * 255)
                        local b = math.floor(selectedColor.B * 255)

                        local maxVal, minVal = math.max(r, g, b), math.min(r, g, b)
                        local h, s, v
                        v = maxVal
                        local delta = maxVal - minVal
                        if maxVal == 0 then
                            s = 0
                        else
                            s = (delta * 255) / maxVal
                        end

                        if maxVal == minVal then
                            h = 0
                        else
                            if maxVal == r then
                                h = ((g - b) * 60) / delta
                                if g < b then h = h + 360 end
                            elseif maxVal == g then
                                h = ((b - r) * 60) / delta + 120
                            elseif maxVal == b then
                                h = ((r - g) * 60) / delta + 240
                            end
                        end
                        hsvHue, hsvSaturation, hsvValue = h / 360, s / 255, v / 255

                        local hexColor = selectedColor:ToHex()
                        fineTuneValueTextBoxes.Hex.TextBox.Text = "#" .. hexColor
                        fineTuneValueTextBoxes.Hue.TextBox.Text = math.floor(h)
                        fineTuneValueTextBoxes.Sat.TextBox.Text = math.round(s)
                        fineTuneValueTextBoxes.Val.TextBox.Text = math.round(v)

                        fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.Hex.TextBox] = fineTuneValueTextBoxes.Hex.TextBox.Text
                        fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.Hue.TextBox] = fineTuneValueTextBoxes.Hue.TextBox.Text
                        fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.Sat.TextBox] = fineTuneValueTextBoxes.Sat.TextBox.Text
                        fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.Val.TextBox] = fineTuneValueTextBoxes.Val.TextBox.Text

                        hueCursor.Position = UDim2.fromScale(1 - h / 359, 1 - hsvSaturation)
                        valueArrow.Position = UDim2.fromScale(0, 1 - hsvValue)
                        colorPreviewSwatch.BackgroundColor3 = selectedColor
                        valueLightnessPad.BackgroundColor3 = Color3.fromHSV(hsvHue, hsvSaturation, 1)
                    end
                else
                    textBox.Text = fineTuneTextBoxCurrentValues[textBox]
                    textBox.CursorPosition = fineTuneTextBoxCursorPositions[textBox]
                    textBox.SelectionStart = fineTuneTextBoxSelectionStarts[textBox]
                end
            end
        end)
    elseif textBox == fineTuneValueTextBoxes.Hex.TextBox then
        fineTuneValueTextBoxes.Hex.TextBox:GetPropertyChangedSignal("Text"):Connect(function()
            if currentlyFocusedTextBox == textBox then
                local newText = fineTuneValueTextBoxes.Hex.TextBox.Text
                if newText == "" or (string.sub(newText, 1, 1) == "#" and not string.sub(newText, 2):match("%X") and #newText < 8) then
                    fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.Hex.TextBox] = newText
                    local success, newColor = pcall(Color3.fromHex, newText)
                    if success then
                        selectedColor = newColor
                        -- RGB to HSV Conversion
                        local r = math.floor(selectedColor.R * 255)
                        local g = math.floor(selectedColor.G * 255)
                        local b = math.floor(selectedColor.B * 255)

                        local maxVal, minVal = math.max(r, g, b), math.min(r, g, b)
                        local h, s, v
                        v = maxVal
                        local delta = maxVal - minVal
                        if maxVal == 0 then
                            s = 0
                        else
                            s = (delta * 255) / maxVal
                        end

                        if maxVal == minVal then
                            h = 0
                        else
                            if maxVal == r then
                                h = ((g - b) * 60) / delta
                                if g < b then h = h + 360 end
                            elseif maxVal == g then
                                h = ((b - r) * 60) / delta + 120
                            elseif maxVal == b then
                                h = ((r - g) * 60) / delta + 240
                            end
                        end
                        hsvHue, hsvSaturation, hsvValue = h / 360, s / 255, v / 255

                        fineTuneValueTextBoxes.R.TextBox.Text = r
                        fineTuneValueTextBoxes.G.TextBox.Text = g
                        fineTuneValueTextBoxes.B.TextBox.Text = b
                        fineTuneValueTextBoxes.Hue.TextBox.Text = math.floor(h)
                        fineTuneValueTextBoxes.Sat.TextBox.Text = math.round(s)
                        fineTuneValueTextBoxes.Val.TextBox.Text = math.round(v)

                        fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.R.TextBox] = fineTuneValueTextBoxes.R.TextBox.Text
                        fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.G.TextBox] = fineTuneValueTextBoxes.G.TextBox.Text
                        fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.B.TextBox] = fineTuneValueTextBoxes.B.TextBox.Text
                        fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.Hue.TextBox] = fineTuneValueTextBoxes.Hue.TextBox.Text
                        fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.Sat.TextBox] = fineTuneValueTextBoxes.Sat.TextBox.Text
                        fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.Val.TextBox] = fineTuneValueTextBoxes.Val.TextBox.Text

                        hueCursor.Position = UDim2.fromScale(1 - h / 359, 1 - hsvSaturation)
                        valueArrow.Position = UDim2.fromScale(0, 1 - hsvValue)
                        colorPreviewSwatch.BackgroundColor3 = selectedColor
                        valueLightnessPad.BackgroundColor3 = Color3.fromHSV(hsvHue, hsvSaturation, 1)
                    end
                else
                    fineTuneValueTextBoxes.Hex.TextBox.Text = fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.Hex.TextBox]
                end
            end
        end)
    end
end

-- Basic Color Palette Swatches
local colorSwatchTemplate = resourcesFolder.Components.ColorSwatch
local basicColorGrid = basicColorPickerPanel.BasicColorGrid
for row = 0, 3 do
    for col = 0, 3 do
        for layer = 0, 2 do
            local newSwatch = colorSwatchTemplate:Clone()
            local swatchColor = Color3.new(col / 3, row / 3, layer / 2)
            local hexString = "#" .. swatchColor:ToHex()
            newSwatch.ColorButton.BackgroundColor3 = swatchColor
            newSwatch.LayoutOrder = row * 12 + col * 3 + layer
            newSwatch.Parent = basicColorGrid
            newSwatch.ColorButton.MouseButton1Click:Connect(function()
                basicColorPickerPanel.Visible = false
                advancedColorPickerPanel.Visible = true
                colorPickerSubtitleLabel.Text = "Advanced Colors"
                selectedColor = swatchColor

                -- RGB to HSV Conversion for display in Advanced tab
                local r = math.floor(selectedColor.R * 255)
                local g = math.floor(selectedColor.G * 255)
                local b = math.floor(selectedColor.B * 255)
                local maxVal, minVal = math.max(r, g, b), math.min(r, g, b)
                local h, s, v
                v = maxVal
                local delta = maxVal - minVal
                if maxVal == 0 then
                    s = 0
                else
                    s = (delta * 255) / maxVal
                end
                if maxVal == minVal then
                    h = 0
                else
                    if maxVal == r then
                        h = ((g - b) * 60) / delta
                        if g < b then h = h + 360 end
                    elseif maxVal == g then
                        h = ((b - r) * 60) / delta + 120
                    elseif maxVal == b then
                        h = ((r - g) * 60) / delta + 240
                    end
                end
                hsvHue, hsvSaturation, hsvValue = h / 360, s / 255, v / 255

                fineTuneValueTextBoxes.Hue.TextBox.Text = math.floor(h)
                fineTuneValueTextBoxes.Sat.TextBox.Text = math.round(s)
                fineTuneValueTextBoxes.Val.TextBox.Text = math.round(v)
                fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.Hue.TextBox] = fineTuneValueTextBoxes.Hue.TextBox.Text
                fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.Sat.TextBox] = fineTuneValueTextBoxes.Sat.TextBox.Text
                fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.Val.TextBox] = fineTuneValueTextBoxes.Val.TextBox.Text

                fineTuneValueTextBoxes.Hex.TextBox.Text = hexString
                fineTuneValueTextBoxes.R.TextBox.Text = col * 85 -- Assuming 0-3 maps to 0, 85, 170, 255
                fineTuneValueTextBoxes.G.TextBox.Text = row * 85
                fineTuneValueTextBoxes.B.TextBox.Text = math.floor(layer * 127.5)
                fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.Hex.TextBox] = fineTuneValueTextBoxes.Hex.TextBox.Text
                fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.R.TextBox] = fineTuneValueTextBoxes.R.TextBox.Text
                fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.G.TextBox] = fineTuneValueTextBoxes.G.TextBox.Text
                fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.B.TextBox] = fineTuneValueTextBoxes.B.TextBox.Text

                hueCursor.Position = UDim2.fromScale(1 - hsvHue, 1 - hsvSaturation)
                valueArrow.Position = UDim2.fromScale(0, 1 - hsvValue)
                colorPreviewSwatch.BackgroundColor3 = selectedColor
                valueLightnessPad.BackgroundColor3 = Color3.fromHSV(hsvHue, hsvSaturation, 1)

                resourcesFolder.Tweens.AdvancedColorsEnter:Play()
            end)
        end
    end
end

basicColorPickerPanel.FooterButton.MouseButton1Click:Connect(function()
    basicColorPickerPanel.Visible = false
    advancedColorPickerPanel.Visible = true
    colorPickerSubtitleLabel.Text = "Advanced Colors"
    resourcesFolder.Tweens.AdvancedColorsEnter:Play()
end)

advancedColorPickerPanel.FooterButton.MouseButton1Click:Connect(function()
    advancedColorPickerPanel.Visible = false
    basicColorPickerPanel.Visible = true
    colorPickerSubtitleLabel.Text = "Basic Colors"
    resourcesFolder.Tweens.AdvancedColorsExit:Play()
end)

-- Close Color Picker Buttons
for _, button in pairs({ colorPickerWidget.TopBar.Close, advancedColorPickerPanel.AdvancedColors.FineTuning.Buttons.Cancel }) do
    button.MouseButton1Click:Connect(function()
        resourcesFolder.Tweens.ColorPickerClose:Play()
        resourcesFolder.Tweens.ColorModalShadeFadeOut:Play()
        activeModalCount = activeModalCount - 1
        if activeModalCount == 0 then
            windowSurfaceGui.Window.Content.Interactable = true
        end
    end)
end

local colorPickerTargetButton -- Store the button that opened the color picker

advancedColorPickerPanel.AdvancedColors.FineTuning.Buttons.OK.MouseButton1Click:Connect(function()
    colorPickerTargetButton.BackgroundColor3 = selectedColor
    resourcesFolder.Tweens.ColorPickerClose:Play()
    resourcesFolder.Tweens.ColorModalShadeFadeOut:Play()
    activeModalCount = activeModalCount - 1
    if activeModalCount == 0 then
        windowSurfaceGui.Window.Content.Interactable = true
    end
    targetColorPropertyObject.Value = selectedColor
    local onChangedCallback = targetColorPropertyObject.OnChanged
    if typeof(onChangedCallback) == "function" then
        coroutine.resume(coroutine.create(onChangedCallback), selectedColor, 0)
    end
end)

-- Icon & Login Tips Setup
do
    local iconSize20px = resourcesFolder.Icons["20px"]
    local ctaContainer = keyFieldContainer.Parent.Parent.CTAContainer
    iconSize20px.meridians:Clone().Parent = ctaContainer.GetKey.IconContainer
    iconSize20px.help:Clone().Parent = ctaContainer.Help.IconContainer
    iconSize20px["lock-open"]:Clone().Parent = keyFieldContainer.Parent.LogIn
    iconSize20px.key:Clone().Parent = keyFieldContainer.Key

    local isFirstTipPage = true
    local loginTipIcons = resourcesFolder.Icons.LoginTips
    local loginTipPageTemplate = resourcesFolder.Components.LoginTipPage
    local pageIndicatorTemplate = resourcesFolder.Components.PageIndicator
    local tipScroller = windowSurfaceGui.Window.Content.Login.TipScroller
    local tipInnerContent = tipScroller.InnerContent
    local uiPageLayout = tipInnerContent.UIPageLayout
    local pageProgressContainer = tipScroller.PageProgress
    local progressBarValue = tipScroller.ProgressBar.ProgressValue

    local tipData = {
        { "Imp Hub Beta", "Support us by testing out beta features before they are released to everyone.", loginTipIcons.Beta, Color3.fromRGB(183, 78, 234) },
        { "Join our Discord!", "Stay updated with news, new games, and interact with our friendly community.", loginTipIcons.DiscordClyde, Color3.fromRGB(89, 112, 226) },
        { "Get Keyless", "Tired of the key system? With Keyless, you get a permanent key that works forever. Never see an ad again.", loginTipIcons.DemonKey, Color3.fromRGB(176, 165, 4) }
    }

    for _, data in pairs(tipData) do
        local tipPage = loginTipPageTemplate:Clone()
        local details = tipPage.Details
        local iconFrame = tipPage.Icon
        details.Title.Text = data[1]
        details.Desc.Text = data[2]
        iconFrame.BackgroundColor3 = data[4]
        data[3]:Clone().Parent = iconFrame
        tipPage.Parent = tipInnerContent

        local pageIndicator = pageIndicatorTemplate:Clone()
        local indicatorBubble = pageIndicator.Bubble
        pageIndicator.Parent = pageProgressContainer
        if isFirstTipPage then
            isFirstTipPage = false
            indicatorBubble.BackgroundTransparency = 0
        end

        -- Connect page layout events to indicator tweens
        local enterTween = tweenService:Create(indicatorBubble, TweenInfo.new(), { BackgroundTransparency = 0 })
        local leaveTween = tweenService:Create(indicatorBubble, TweenInfo.new(), { BackgroundTransparency = 1 })

        uiPageLayout.PageEnter:Connect(function(page)
            if page == tipPage then
                enterTween:Play()
            end
        end)
        uiPageLayout.PageLeave:Connect(function(page)
            if page == tipPage then
                leaveTween:Play()
            end
        end)
    end

    local currentTipPageIndex = 1
    local progressBarTween = tweenService:Create(progressBarValue, TweenInfo.new(10, Enum.EasingStyle.Linear), { Size = UDim2.fromScale(1, 2) })

    local function startLoginTipCycle()
        progressBarValue.Size = UDim2.fromScale(0, 2)
        progressBarTween:Play()
        uiPageLayout:JumpToIndex(currentTipPageIndex)
        if currentTipPageIndex == 3 then
            currentTipPageIndex = 1
        else
            currentTipPageIndex = currentTipPageIndex + 1
        end
    end

    progressBarTween.Completed:Connect(startLoginTipCycle)
    progressBarTween:Play()
    loginTipIcons.DiscordClyde:Clone().Parent = windowSurfaceGui.Window.Content.Login.DiscordButton
end

local function updateTooltipPosition(targetPosition, targetSize, positionType)
    local anchorPoint, tailAnchorPoint
    tooltipListLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
    tooltipListLayout.VerticalAlignment = Enum.VerticalAlignment.Top
    tooltipTailContainer.Position = UDim2.fromScale(0.5)
    tooltipTailContainer.Size = UDim2.fromOffset(8, 7)
    tooltipTailLeftClip.Position = UDim2.fromOffset()
    tooltipTailLeftClip.AnchorPoint = Vector2.zero
    tooltipTailLeftClip.Size = UDim2.fromOffset(4, 7)
    tooltipTailRightClip.Position = UDim2.fromScale(1)
    tooltipTailRightClip.AnchorPoint = Vector2.xAxis
    tooltipTailRightClip.Size = UDim2.fromOffset(4, 7)
    tooltipTailLeftFrame.Position = UDim2.new(0, 1, 1)
    tooltipTailLeftFrame.AnchorPoint = Vector2.new(0, 0.5)
    tooltipTailRightFrame.Position = UDim2.new(1, -1, 1)
    tooltipTailRightFrame.AnchorPoint = Vector2.new(1, 0.5)
    
    if positionType == 1 then -- Top
        anchorPoint = Vector2.new(0.5)
        tailAnchorPoint = Vector2.new(0.5, 1)
    elseif positionType == 2 then -- Left
        anchorPoint = Vector2.new(0, 0.5)
        tailAnchorPoint = Vector2.new(1, 0.5)
        tooltipListLayout.HorizontalAlignment = Enum.HorizontalAlignment.Left
        tooltipListLayout.VerticalAlignment = Enum.VerticalAlignment.Center
        tooltipTailContainer.Position = UDim2.new(0, -4, 0.5)
        tooltipTailContainer.Size = UDim2.fromOffset(7, 8)
        tooltipTailLeftClip.Position = UDim2.fromOffset()
        tooltipTailLeftClip.AnchorPoint = Vector2.zero
        tooltipTailLeftClip.Size = UDim2.fromOffset(7, 4)
        tooltipTailRightClip.Position = UDim2.fromScale(0, 1)
        tooltipTailRightClip.AnchorPoint = Vector2.yAxis
        tooltipTailRightClip.Size = UDim2.fromOffset(7, 4)
        tooltipTailLeftFrame.Position = UDim2.new(1, 0, 0, 1)
        tooltipTailLeftFrame.AnchorPoint = Vector2.new(0.5)
        tooltipTailRightFrame.Position = UDim2.new(1, 0, 1, -1)
        tooltipTailRightFrame.AnchorPoint = Vector2.new(0.5, 1)
    elseif positionType == 3 then -- Bottom
        anchorPoint = Vector2.new(0.5, 1)
        tailAnchorPoint = Vector2.new(0.5, 0)
        tooltipListLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
        tooltipListLayout.VerticalAlignment = Enum.VerticalAlignment.Bottom
        tooltipTailContainer.Position = UDim2.fromScale(0.5, 1)
        tooltipTailContainer.Size = UDim2.fromOffset(8, 7)
        tooltipTailLeftClip.Position = UDim2.fromOffset()
        tooltipTailLeftClip.AnchorPoint = Vector2.zero
        tooltipTailLeftClip.Size = UDim2.fromOffset(4, 7)
        tooltipTailRightClip.Position = UDim2.fromScale(1)
        tooltipTailRightClip.AnchorPoint = Vector2.xAxis
        tooltipTailRightClip.Size = UDim2.fromOffset(4, 7)
        tooltipTailLeftFrame.Position = UDim2.fromOffset(1)
        tooltipTailLeftFrame.AnchorPoint = Vector2.new(0, 0.5)
        tooltipTailRightFrame.Position = UDim2.new(1, -1)
        tooltipTailRightFrame.AnchorPoint = Vector2.new(1, 0.5)
    end
    tooltipTailContainer.AnchorPoint = tailAnchorPoint
    local tooltipPosition = targetPosition + targetSize * tailAnchorPoint
    
    tweenService:Create(tooltipContainer, TweenInfo.new(0.2), { Size = UDim2.fromOffset(tooltipTextBubble.AbsoluteSize.X, tooltipTextBubble.AbsoluteSize.Y), Position = UDim2.fromOffset(tooltipPosition.X, tooltipPosition.Y), AnchorPoint = anchorPoint }):Play()
end

-- Hub Navigation and Page Setup
do
    local navTooltipElements = {} -- Store elements for tooltip handling
    local windowControls = windowSurfaceGui.Window.Content.TopBar.WindowControls
    local defaultTooltips = {
        { windowSurfaceGui.Window.Content.Login.LoginBox.LoginLayout.LogIn, "Check Key", 1 },
        { windowSurfaceGui.Window.Content.Login.DiscordButton, "Discord Server", 3 },
        { windowControls.Minimize, "Minimize", 1 },
        { windowControls.Maximize, "Mini View", 1 },
        { windowControls.Close, "Close", 1 }
    }

    local activeHubTabButton
    local activeHubTabPage
    local isFirstHubTab = true

    local pageViewContainer = windowSurfaceGui.Window.Content.Hub.MainContent.PageView
    local navButtonsContainer = windowSurfaceGui.Window.Content.Hub.MainContent.NavButtons
    local navigationIcons = resourcesFolder.Icons.Navigation
    local navButtonTemplate = resourcesFolder.Components.Nav

    local navPageData = {
        { "Home", navigationIcons.home, pageViewContainer.Home },
        { "About", navigationIcons.info, pageViewContainer.About },
        { "Settings", navigationIcons.cog, pageViewContainer.Settings }
    }

    for index, data in next, navPageData do
        local navButton = navButtonTemplate:Clone()
        local page = data[3]
        local buttonName = data[1]
        navButton.Name = buttonName
        navButton.LayoutOrder = index
        data[2]:Clone().Parent = navButton
        table.insert(defaultTooltips, { navButton, buttonName, 2 })
        navButton.Parent = navButtonsContainer
        navTooltipElements[navButton] = buttonName

        navButton.MouseButton1Click:Connect(function()
            page.Visible = true
            tweenService:Create(activeHubTabButton, TweenInfo.new(0.2), { BackgroundColor3 = Color3.fromRGB(59, 59, 59) }):Play()
            tweenService:Create(navButton, TweenInfo.new(0.2), { BackgroundColor3 = impThemeColors.NavButtonActive.Value }):Play()

            local prevActivePage = activeHubTabPage
            local hideTween = tweenService:Create(activeHubTabPage, TweenInfo.new(0.5), { Position = UDim2.fromScale(0, -1) })
            hideTween:Play()
            hideTween.Completed:Once(function(_, playbackState)
                if playbackState == Enum.PlaybackState.Completed then
                    prevActivePage.Visible = false
                end
            end)
            tweenService:Create(page, TweenInfo.new(0.5), { Position = UDim2.fromOffset() }):Play()
            activeHubTabButton = navButton
            activeHubTabPage = page
        end)

        if isFirstHubTab then
            isFirstHubTab = false
            navButton.BackgroundColor3 = impThemeColors.NavButtonActive.Value
            activeHubTabButton = navButton
            activeHubTabPage = page
        end
    end

    -- Tooltip connections for navigation and window controls
    for _, tooltipData in next, defaultTooltips do
        local element = tooltipData[1]
        local tooltipText = tooltipData[2]
        local tooltipPositionHint = tooltipData[3] -- 1=top, 2=left, 3=bottom

        element.MouseEnter:Connect(function()
            if not activeSliderKnob then -- Don't show tooltips if dragging a slider
                currentTooltipElement = element
                tooltipTextLabel.Text = tooltipText
                updateTooltipPosition(element.AbsolutePosition, element.AbsoluteSize, tooltipPositionHint)
            end
        end)

        element.MouseLeave:Connect(function()
            if currentTooltipElement == element and not activeSliderKnob then
                hideTooltipTween:Play()
            end
        end)
    end
end

-- Cleanup Function
local function cleanupGui()
    resourcesFolder.Bindables.HubDestroying:Fire()
    renderConnection:Disconnect()
    inputBeganConnection:Disconnect()
    inputChangedConnection:Disconnect()
    inputEndedConnection:Disconnect()
    windowSurfaceGui:Destroy()
    rendererPart:Destroy()
    playerScreenGui:Destroy()
    Constants, WINDOW_DEFAULT_SIZE, currentCamera, windowSurfaceGui, keyFieldContainer, keyTextBox, screenContainer, hubPositionFrame, minimizedTaskbarButton, tweenService, rendererPart, playerScreenGui, renderConnection, inputChangedConnection, inputEndedConnection, isMinimized, isSmallWindow, isWhitelistActive, hubPositionBeforeMinimize, lastTouchInput, cleanupGui, publicApiTable = nil
    script:Destroy()
    script = nil
end

local isFirstPageInHub = true
local activeTabButton -- Renamed from k
local activeTabPage -- Renamed from m
local dialogTypeNames = { "Note", "Tip", "Important", "Warning", "Caution" }

publicApiTable = {
    Base = playerScreenGui,
    Screen = playerScreenGui,
    Renderer = rendererPart,
    Gui = windowSurfaceGui,
    Window = {
        Object = windowSurfaceGui.Window,
        IsMinimized = false,
        IsSmall = false,
        IsOpen = false,
        SetSubtitle = function(_, text, version)
            subtitleLabel.Text = text
            if version ~= nil then
                versionLabel.Text = tostring(version)
                versionLabel.Visible = true
            else
                versionLabel.Visible = false
            end
        end,
        ShowMessage = function(_, title, text)
            publicApiTable.Window:ShowDialog({ Title = title, Text = text })
        end,
        ShowDialog = function(_, dialogOptions)
            if typeof(dialogOptions) == "table" then
                if not isModalTransitioning then
                    resourcesFolder.Tweens.ModalShadeFadeIn:Play()
                    activeModalCount = activeModalCount + 1
                    windowSurfaceGui.Window.Content.Interactable = false
                end
                local dialogFrame = resourcesFolder.Components.Modal:Clone()
                if dialogOptions.Transparent == false then
                    dialogFrame.BackgroundTransparency = 0
                end
                local dialogTitle = dialogOptions.Title
                local dialogText = dialogOptions.Text
                local buttons = dialogOptions.Buttons
                if dialogTitle ~= nil then
                    dialogFrame.Inner.DialogTitle.Text = tostring(dialogTitle)
                end
                if dialogText ~= nil then
                    dialogFrame.Inner.DialogText.Text = tostring(dialogText)
                end

                local function showNextDialogInQueue()
                    local _, nextDialog = next(dialogQueue)
                    if not isModalTransitioning then
                        if nextDialog then
                            showModal(nextDialog)
                        else
                            resourcesFolder.Tweens.ModalShadeFadeOut:Play()
                            activeModalCount = activeModalCount - 1
                            if activeModalCount == 0 then
                                windowSurfaceGui.Window.Content.Interactable = true
                            end
                        end
                    end
                end

                local function onDialogClose(modalFrame, tween)
                    if tween.PlaybackState ~= Enum.PlaybackState.Cancelled then
                        modalFrame:Destroy()
                        tween:Destroy()
                        isModalTransitioning = false
                        showNextDialogInQueue()
                    end
                end

                local function closeDialog(modalFrame)
                    for _, child in pairs(modalFrame:GetChildren()) do
                        if child:IsA("GuiButton") then
                            child.Interactable = false
                        end
                    end
                    local hideTween = tweenService:Create(modalFrame, TweenInfo.new(0.25, Enum.EasingStyle.Quad, Enum.EasingDirection.In), { Position = UDim2.fromScale(0.5, 1), AnchorPoint = Vector2.new(0.5) })
                    hideTween.Completed:Once(function()
                        onDialogClose(modalFrame, hideTween)
                    end)
                    hideTween:Play()
                end

                if not (typeof(buttons) == "table" and #buttons ~= 0) then
                    buttons = { { Title = "OK" } }
                end
                for _, buttonOptions in next, buttons do
                    if typeof(buttonOptions) == "table" then
                        local button = resourcesFolder.Components.ModalButton:Clone()
                        local title = buttonOptions.Title
                        local callback = buttonOptions.Callback
                        if title then
                            button.Text = tostring(title)
                        end
                        if buttonOptions.Secondary then
                            button.BackgroundColor3 = Color3.new(1, 1, 1)
                        end
                        button.MouseButton1Click:Connect(function()
                            if typeof(callback) == "function" then
                                coroutine.resume(coroutine.create(callback), title, _, dialogOptions.Nonce)
                            end
                            closeDialog(dialogFrame)
                        end)
                        button.Parent = dialogFrame.Inner
                    end
                end

                if dialogOptions.CopyBoxText ~= nil then
                    local copyBox = dialogFrame.Inner.CopyLayout.CopyBox
                    local textToCopy = tostring(dialogOptions.CopyBoxText)
                    copyBox.Text = textToCopy
                    copyBox.Parent.Visible = true

                    local cursorConnection
                    copyBox.Focused:Connect(function()
                        copyBox.SelectionStart = 0
                        copyBox.CursorPosition = #copyBox.Text + 1
                        cursorConnection = copyBox:GetPropertyChangedSignal("CursorPosition"):Connect(function()
                            copyBox.SelectionStart = 0
                            copyBox.CursorPosition = #copyBox.Text + 1
                        end)
                    end)
                    copyBox.FocusLost:Connect(function()
                        if cursorConnection then
                            cursorConnection:Disconnect()
                        end
                    end)

                    local clipboardFunction = setclipboard or toclipboard or set_clipboard or (Clipboard and Clipboard.set) or CopyString
                    local copyButton = dialogFrame.Inner.CopyLayout.CopyButton
                    if clipboardFunction then
                        resourcesFolder.Icons["20px"].copy:Clone().Parent = copyButton
                        copyButton.MouseButton1Click:Connect(function()
                            clipboardFunction(textToCopy)
                            copyButton.DoneFrame.Visible = true
                            copyButton.BackgroundColor3 = Color3.fromRGB(64, 162, 64)
                            tweenService:Create(copyButton.DoneFrame, TweenInfo.new(5), { Visible = false }):Play()
                            tweenService:Create(copyButton, TweenInfo.new(5, Enum.EasingStyle.Back, Enum.EasingDirection.In), { BackgroundColor3 = Color3.fromRGB(100, 100, 100) }):Play()
                        end)
                    else
                        copyButton.Visible = false
                    end
                end

                local function showModal(modalFrame)
                    table.remove(dialogQueue, table.find(dialogQueue, modalFrame))
                    isModalTransitioning = true
                    local showTween = tweenService:Create(modalFrame, TweenInfo.new(0.25), { Position = UDim2.fromScale(0.5, 0.5), AnchorPoint = Vector2.new(0.5, 0.5) })
                    showTween:Play()
                end
                table.insert(dialogQueue, dialogFrame)
                showNextDialogInQueue()
            end
        end,
        SetMinimized = function(_, shouldMinimize, animate)
            if shouldMinimize == nil then shouldMinimize = true end
            if animate == nil then animate = true end

            if (not not shouldMinimize) ~= isMinimized then
                isMinimized = shouldMinimize
                if shouldMinimize then
                    hubPositionBeforeMinimize = screenContainer.Position
                    if animate then
                        local minimizeTween = resourcesFolder.Tweens.GuiExit
                        tweenService:Create(screenContainer, TweenInfo.new(), { Position = UDim2.fromOffset(minimizedTaskbarButton.AbsolutePosition.X + minimizedTaskbarButton.AbsoluteSize.X / 2, minimizedTaskbarButton.AbsolutePosition.Y + minimizedTaskbarButton.AbsoluteSize.Y / 2) }):Play()
                        resourcesFolder.Tweens.CanvasMin:Play()
                        minimizeTween:Play()
                        publicApiTable.Window.IsMinimized = shouldMinimize
                        resourcesFolder.Bindables.MinimizedChanged:Fire(shouldMinimize)
                        minimizeTween.Completed:Once(function()
                            minimizedTaskbarButton.Visible = true
                        end)
                    else
                        screenContainer.Position = UDim2.fromOffset(minimizedTaskbarButton.AbsolutePosition.X + minimizedTaskbarButton.AbsoluteSize.X / 2, minimizedTaskbarButton.AbsolutePosition.Y + minimizedTaskbarButton.AbsoluteSize.Y / 2)
                        windowSurfaceGui.CanvasSize = Vector2.zero
                        hubPositionFrame.Size = UDim2.fromOffset()
                        minimizedTaskbarButton.Visible = true
                        publicApiTable.Window.IsMinimized = shouldMinimize
                        resourcesFolder.Bindables.MinimizedChanged:Fire(shouldMinimize)
                    end
                else
                    minimizedTaskbarButton.Visible = false
                    screenContainer.Position = UDim2.fromOffset(minimizedTaskbarButton.AbsolutePosition.X + minimizedTaskbarButton.AbsoluteSize.X / 2, minimizedTaskbarButton.AbsolutePosition.Y + minimizedTaskbarButton.AbsoluteSize.Y / 2)
                    if animate then
                        tweenService:Create(screenContainer, TweenInfo.new(), { Position = hubPositionBeforeMinimize }):Play()
                        if isSmallWindow then
                            resourcesFolder.Tweens.GuiHalf:Play()
                        else
                            resourcesFolder.Tweens.GuiFull:Play()
                        end
                        resourcesFolder.Tweens.CanvasFull:Play()
                    else
                        if isSmallWindow then
                            hubPositionFrame.Size = UDim2.fromScale(0.5, 0.5)
                        else
                            hubPositionFrame.Size = UDim2.fromScale(1, 1)
                        end
                        windowSurfaceGui.CanvasSize = WINDOW_DEFAULT_SIZE
                    end
                    publicApiTable.Window.IsMinimized = not not shouldMinimize
                    resourcesFolder.Bindables.MinimizedChanged:Fire(not not shouldMinimize)
                end
            end
        end,
        SetSmall = function(_, shouldBeSmall, animate)
            if shouldBeSmall == nil then shouldBeSmall = true end
            if animate == nil then animate = true end
            if (not not shouldBeSmall) ~= isSmallWindow then
                isSmallWindow = shouldBeSmall
                if shouldBeSmall then
                    if animate then
                        resourcesFolder.Tweens.GuiHalf:Play()
                    else
                        hubPositionFrame.Size = UDim2.fromScale(0.5, 0.5)
                    end
                else
                    if animate then
                        resourcesFolder.Tweens.GuiFull:Play()
                    else
                        hubPositionFrame.Size = UDim2.fromScale(1, 1)
                    end
                end
                publicApiTable.Window.IsSmall = not not shouldBeSmall
                resourcesFolder.Bindables.SizeChanged:Fire(not not shouldBeSmall)
            end
        end,
        Open = function(_, animate)
            if animate == nil then animate = true end
            if not isMinimized then
                if animate then
                    hubPositionFrame.Size = UDim2.fromOffset()
                    windowSurfaceGui.CanvasSize = Vector2.zero
                    if isSmallWindow then
                        resourcesFolder.Tweens.GuiEnterHalf:Play()
                    else
                        resourcesFolder.Tweens.GuiEnterFull:Play()
                    end
                    resourcesFolder.Tweens.CanvasFull:Play()
                else
                    if isSmallWindow then
                        hubPositionFrame.Size = UDim2.fromScale(0.5, 0.5)
                    else
                        hubPositionFrame.Size = UDim2.fromScale(1, 1)
                    end
                    windowSurfaceGui.CanvasSize = WINDOW_DEFAULT_SIZE
                end
            end
            publicApiTable.Window.IsOpen = true
            resourcesFolder.Bindables.Opened:Fire()
        end,
        Close = function(_, animate)
            if animate == nil then animate = true end
            if animate then
                local minimizeTween = resourcesFolder.Tweens.GuiExit
                resourcesFolder.Tweens.CanvasMin:Play()
                minimizeTween:Play()
                publicApiTable.Window.IsOpen = false
                resourcesFolder.Bindables.Closing:Fire()
                minimizeTween.Completed:Once(cleanupGui)
            else
                publicApiTable.Window.IsOpen = false
                resourcesFolder.Bindables.Closing:Fire()
                cleanupGui()
            end
        end,
        SetLoadingState = function(_, isLoading)
            isLoading = not not isLoading
            local loadingScreen = windowSurfaceGui.Window.LoadingScreen
            if loadingScreen.Visible ~= isLoading then
                if isLoading then
                    activeModalCount = activeModalCount + 1
                    windowSurfaceGui.Window.Content.Interactable = false
                else
                    activeModalCount = activeModalCount - 1
                    if activeModalCount == 0 then
                        windowSurfaceGui.Window.Content.Interactable = true
                    end
                end
                loadingScreen.Visible = isLoading
            end
        end,
        MinimizedChanged = resourcesFolder.Bindables.MinimizedChanged.Event,
        SizeChanged = resourcesFolder.Bindables.SizeChanged.Event,
        Opened = resourcesFolder.Bindables.Opened.Event,
        Closing = resourcesFolder.Bindables.Closing.Event
    },
    Login = {
        Object = windowSurfaceGui.Window.Content.Login,
        IsWhitelist = false,
        SetKeyLink = function(_, link) Constants.KEY_LINK = tostring(link) end,
        SetWhitelistLink = function(_, link) Constants.WHITELIST_LINK = tostring(link) end,
        SetDiscordLink = function(_, link) Constants.DISCORD_INVITE = tostring(link) end,
        SetWhitelist = function(_, isWhitelist) end, -- Function seems to be empty in original
        ChangeTheme = function(_, themeName) end, -- Function seems to be empty in original
        WhitelistChanged = resourcesFolder.Bindables.WhitelistChanged.Event,
        LoginRequest = resourcesFolder.Bindables.LoginRequest.Event
    },
    Hub = {
        Object = windowSurfaceGui.Window.Content.Hub,
        CreatePage = function(_, pageTitle, iconName)
            local tabButton = resourcesFolder.Components.Tab:Clone()
            local pageFrame = resourcesFolder.Components.Page:Clone()

            tabButton.Label.Text = pageTitle
            tabButton.Name = "Tab_" .. pageTitle
            pageFrame.Name = "Page_" .. pageTitle

            if iconName then
                local icon = resourcesFolder.Icons["20px"]:FindFirstChild(iconName)
                if icon then
                    icon:Clone().Parent = tabButton.Icon
                end
            end

            tabButton.Parent = homePageSidebar
            pageFrame.Parent = pageContentFrame

            tabButton.MouseButton1Click:Connect(function()
                pageFrame.Visible = true
                tweenService:Create(activeTabButton, TweenInfo.new(0.2), { BackgroundColor3 = Color3.fromRGB(82, 82, 82) }):Play()
                tweenService:Create(tabButton, TweenInfo.new(0.2), { BackgroundColor3 = impThemeColors.TabButtonActive.Value }):Play()

                local prevActivePage = activeTabPage
                local hideTween = tweenService:Create(activeTabPage, TweenInfo.new(0.5), { Position = UDim2.fromScale(0.5, -1) })
                hideTween:Play()
                hideTween.Completed:Once(function(_, playbackState)
                    if playbackState == Enum.PlaybackState.Completed then
                        prevActivePage.Visible = false
                    end
                end)
                tweenService:Create(pageFrame, TweenInfo.new(0.5), { Position = UDim2.fromScale(0.5) }):Play()
                tweenService:Create(pageContentFrame.Parent, TweenInfo.new(0.5), { CanvasPosition = Vector2.zero }):Play() -- Reset scroll
                activeTabButton = tabButton
                activeTabPage = pageFrame
            end)

            if isFirstPageInHub then
                pageFrame.Visible = true
                pageFrame.Position = UDim2.fromScale(0.5)
                isFirstPageInHub = false
                tabButton.BackgroundColor3 = impThemeColors.TabButtonActive.Value
                activeTabButton = tabButton
                activeTabPage = pageFrame
            end

            local pageApi = {
                Instance = pageFrame,
                TabInstance = tabButton,
                Object = tabButton,
                Page = pageFrame,
                CreateSection = function(page, sectionTitle, isPageSection, hideTitle)
                    local sectionFrame = resourcesFolder.Components.Section:Clone()
                    sectionFrame.Name = "Section_" .. sectionTitle
                    sectionFrame.Title.Text = tostring(sectionTitle)
                    if hideTitle then sectionFrame.Title.Visible = false end

                    sectionFrame.Parent = page.Page
                    return {
                        Object = sectionFrame,
                        HasSetVisibility = false,
                        CreateSeparator = function(sectionApi)
                            local separator = resourcesFolder.Components.Separator:Clone()
                            if not sectionApi.PageSection then
                                separator.Parent = sectionApi.Object.ListBase
                            else
                                separator.Parent = sectionApi.Object
                            end
                        end,
                        CreateElement = function(sectionApi, elementType, elementProperties)
                            if not sectionApi.HasSetVisibility then
                                if not sectionApi.PageSection then
                                    sectionApi.Object.ListBase.Visible = true
                                end
                                sectionApi.HasSetVisibility = true
                            end

                            elementProperties = typeof(elementProperties) == "table" and table.clone(elementProperties) or {}

                            function elementProperties.SetLabel(elementApi, labelOptions)
                                if typeof(labelOptions) == "table" then
                                    local title = labelOptions.Title
                                    local text = labelOptions.Text
                                    if title ~= nil then
                                        elementApi.LabelContainer.Title.Text = tostring(title)
                                    end
                                    if text ~= nil then
                                        elementApi.LabelContainer.Description.Text = tostring(text)
                                        elementApi.Label.Text = tostring(text)
                                    end
                                end
                            end

                            local onChangeBindable = Instance.new("BindableEvent")
                            local elementTemplate = resourcesFolder.Elements:FindFirstChild(elementType)
                            if elementTemplate then
                                local elementInstance = elementTemplate:Clone()
                                elementInstance.Name = "Element_" .. elementType

                                if elementType == "Alert" then
                                    local alertTypeIndex = tonumber(elementProperties.Type)
                                    local alertTypeName = dialogTypeNames[alertTypeIndex]
                                    local accentColor
                                    if alertTypeName then
                                        accentColor = resourcesFolder.Styles.Alerts[alertTypeName].AccentColor.Value
                                        elementInstance.Background.BackgroundColor3 = resourcesFolder.Styles.Alerts[alertTypeName].PrimaryColor.Value
                                        local alertIcon = resourcesFolder.Icons.Alerts[alertTypeName]:Clone()
                                        for _, descendant in next, alertIcon:GetDescendants() do
                                            if descendant.ClassName == "Frame" then
                                                descendant.BackgroundColor3 = accentColor
                                            elseif descendant.ClassName == "UIStroke" then
                                                descendant.Color = accentColor
                                            end
                                        end
                                        alertIcon.Parent = elementInstance
                                    else
                                        elementProperties.AlertType = 0
                                    end
                                    local elementLabel = elementInstance.Label
                                    local labelOptions = elementProperties.Label
                                    labelOptions = typeof(labelOptions) == "table" and table.clone(labelOptions) or {}
                                    local title = labelOptions.Title
                                    local text = labelOptions.Text
                                    title = title ~= nil and tostring(title) or alertTypeName
                                    text = text ~= nil and tostring(text) or ""
                                    elementLabel.Title.Text = title
                                    elementLabel.Description.Text = text
                                    labelOptions.Title = title
                                    labelOptions.Text = text
                                    if alertTypeName then elementLabel.Title.TextColor3 = accentColor end
                                    elementProperties.LabelContainer = elementLabel
                                    elementProperties.Label = labelOptions
                                else
                                    local elementLabel = resourcesFolder.Components.Label:Clone()
                                    local labelOptions = elementProperties.Label
                                    labelOptions = typeof(labelOptions) == "table" and table.clone(labelOptions) or {}
                                    local title = labelOptions.Title
                                    local text = labelOptions.Text
                                    title = title ~= nil and tostring(title) or ""
                                    text = text ~= nil and tostring(text) or ""
                                    elementLabel.Title.Text = title
                                    elementLabel.Description.Text = text
                                    labelOptions.Title = title
                                    labelOptions.Text = text
                                    elementLabel.Parent = elementInstance
                                    elementProperties.LabelContainer = elementLabel
                                    elementProperties.Label = labelOptions

                                    if elementType == "Toggle" then
                                        local toggleFrame = elementInstance.Base.ToggleFrame
                                        local tick1Target = toggleFrame.Tick1.Target
                                        local tick2Target = toggleFrame.Tick2.Target
                                        local toggleValue = not not elementProperties.Value
                                        if toggleValue then
                                            tick1Target.Size = UDim2.fromOffset(8, 2)
                                            tick2Target.Size = UDim2.fromOffset(14, 2)
                                            toggleFrame.BackgroundColor3 = impThemeColors.ToggleActive.Value
                                        end
                                        elementProperties.Value = toggleValue

                                        local activateTweenBg = tweenService:Create(toggleFrame, TweenInfo.new(0.5), { BackgroundColor3 = impThemeColors.ToggleActive.Value })
                                        local activateTweenTick1 = tweenService:Create(tick1Target, TweenInfo.new(0.5, Enum.EasingStyle.Back), { Size = UDim2.fromOffset(8, 2) })
                                        local activateTweenTick2 = tweenService:Create(tick2Target, TweenInfo.new(0.5, Enum.EasingStyle.Back), { Size = UDim2.fromOffset(14, 2) })
                                        local deactivateTweenBg = tweenService:Create(toggleFrame, TweenInfo.new(0.5, Enum.EasingStyle.Quad, Enum.EasingDirection.In), { BackgroundColor3 = Color3.new() })
                                        local deactivateTweenTick1 = tweenService:Create(tick1Target, TweenInfo.new(0.5, Enum.EasingStyle.Back, Enum.EasingDirection.In), { Size = UDim2.fromOffset() })
                                        local deactivateTweenTick2 = tweenService:Create(tick2Target, TweenInfo.new(0.5, Enum.EasingStyle.Back, Enum.EasingDirection.In), { Size = UDim2.fromOffset() })

                                        local function toggleFunction()
                                            toggleValue = not toggleValue
                                            if toggleValue then
                                                activateTweenBg:Play()
                                                activateTweenTick1:Play()
                                                activateTweenTick2:Play()
                                            else
                                                deactivateTweenBg:Play()
                                                deactivateTweenTick1:Play()
                                                deactivateTweenTick2:Play()
                                            end
                                            elementProperties.Value = toggleValue
                                            local onChangedCallback = elementProperties.OnChanged
                                            onChangedCallback = typeof(onChangedCallback) == "function" and onChangedCallback or nil
                                            if onChangedCallback then
                                                coroutine.resume(coroutine.create(onChangedCallback), toggleValue)
                                            end
                                        end
                                        elementInstance.ClickArea.MouseButton1Click:Connect(toggleFunction)
                                        function elementProperties.SetValue(_, value)
                                            if value ~= toggleValue then toggleFunction() end
                                        end
                                        elementProperties.Toggle = toggleFunction

                                    elseif elementType == "Dropdown" then
                                        local isDropdownOpen = false
                                        local currentValuesList = {}
                                        local selectedValues = {}
                                        local optionTextCache = {}
                                        local valueToOptionButton = {}
                                        local activateOptionTweens = {}
                                        local deactivateOptionTweens = {}
                                        local dropdownOptionsContainer = elementInstance.Base.DropDownContainer.List.Options
                                        local optionTextLabel = elementInstance.Base.DropDownContainer.Label.OptionText
                                        local dropdownCurrentlyEnabled = false
                                        local placeholderText = elementProperties.PlaceholderText
                                        placeholderText = placeholderText and tostring(placeholderText) or "Select..."
                                        elementProperties.PlaceholderText = placeholderText
                                        optionTextLabel.Text = placeholderText
                                        elementProperties.Selected = selectedValues

                                        function elementProperties.AddValues(_, valuesToAdd, updateSelection) end -- This function appears to be empty in original
                                        function elementProperties.SetValues(_, newValues, newSelection)
                                            if dropdownCurrentlyEnabled then elementProperties.Selected = selectedValues end
                                            newValues = typeof(newValues) == "table" and newValues or { newValues }
                                            if newSelection ~= nil then
                                                newSelection = typeof(newSelection) == "table" and newSelection or { newSelection }
                                            end

                                            if newValues ~= nil and newValues ~= currentValuesList then
                                                table.clear(currentValuesList)
                                                for _, val in next, newValues do currentValuesList[_] = val end
                                                currentValuesList = table.clone(newValues)
                                                newValues = nil
                                            end

                                            local removedButtons = {}
                                            local currentValuesCopy = table.clone(currentValuesList)
                                            for button, value in pairs(valueToOptionButton) do
                                                local foundIndex = table.find(currentValuesCopy, value)
                                                if foundIndex then
                                                    table.remove(currentValuesCopy, foundIndex)
                                                    local isSelected = table.find(selectedValues, value)
                                                    if newSelection ~= nil then
                                                        local isNewSelection = table.find(newSelection, value)
                                                        if isNewSelection and not isSelected then
                                                            activateOptionTweens[value]:Play()
                                                        elseif not isNewSelection and isSelected then
                                                            deactivateOptionTweens[value]:Play()
                                                        end
                                                    end
                                                else
                                                    button:Destroy()
                                                    table.insert(removedButtons, button)
                                                    if not table.find(currentValuesList, value) then optionTextCache[value] = nil end
                                                end
                                            end
                                            for _, button in removedButtons do valueToOptionButton[button] = nil end

                                            local oldSelected = selectedValues
                                            local currentSelection
                                            local newSelectionCopy
                                            if newSelection ~= nil and newSelection ~= selectedValues then
                                                currentSelection = newSelection
                                                newSelectionCopy = table.clone(newSelection)
                                            else
                                                currentSelection = selectedValues
                                                newSelectionCopy = table.clone(selectedValues)
                                            end

                                            for _, value in pairs(newSelectionCopy) do
                                                if not table.find(currentValuesList, value) then
                                                    table.remove(currentSelection, table.find(currentSelection, value))
                                                end
                                            end

                                            local selectionChanged = false
                                            if currentSelection == newSelectionCopy then
                                                table.clear(selectedValues)
                                                for idx, val in next, newSelection do selectedValues[idx] = val end
                                            end

                                            -- Check if any actual change occurred
                                            if (function(a, b)
                                                for k, v in next, a do if b[k] ~= v then return true end end
                                                for k, v in next, b do if a[k] ~= v then return true end end
                                                return false
                                            end)(oldSelected, currentSelection) then
                                                selectionChanged = true
                                            end

                                            newSelectionCopy = nil
                                            for _, val in pairs(currentValuesCopy) do
                                                local optionButton = resourcesFolder.Components.DropDownOption:Clone()
                                                optionTextCache[val] = tostring(val)
                                                optionButton.Text = optionTextCache[val]
                                                optionButton.Parent = dropdownOptionsContainer

                                                local activateTween = tweenService:Create(optionButton, TweenInfo.new(0.2), { BackgroundColor3 = impThemeColors.DropdownOptionActive.Value })
                                                local deactivateTween = tweenService:Create(optionButton, TweenInfo.new(0.2), { BackgroundColor3 = Color3.fromRGB(37, 37, 37) })
                                                activateOptionTweens[val] = activateTween
                                                deactivateOptionTweens[val] = deactivateTween

                                                local isCurrentlySelected = table.find(selectedValues, val)
                                                if isCurrentlySelected then activateTween:Play() end

                                                if typeof(val) == "Instance" then
                                                    val:GetPropertyChangedSignal("Name"):Connect(function()
                                                        optionTextCache[val] = tostring(val)
                                                        optionButton.Text = optionTextCache[val]
                                                        if #selectedValues > 0 then
                                                            local displayText = ""
                                                            for idx, selectedVal in pairs(selectedValues) do
                                                                if next(selectedValues, idx) then
                                                                    displayText = displayText .. optionTextCache[selectedVal] .. ", "
                                                                else
                                                                    displayText = displayText .. optionTextCache[selectedVal]
                                                                end
                                                            end
                                                            optionTextLabel.Text = displayText
                                                        end
                                                    end)
                                                    val.Destroying:Once(function()
                                                        local valuesListIndex = table.find(currentValuesList, val)
                                                        local selectedListIndex = table.find(selectedValues, val)
                                                        if valuesListIndex then
                                                            table.remove(currentValuesList, valuesListIndex)
                                                            optionButton:Destroy()
                                                            if val.Parent then valueToOptionButton[optionButton] = nil end -- Check if it's still parented.
                                                            if not table.find(currentValuesList, val) then optionTextCache[val] = nil end
                                                        end
                                                        if selectedListIndex then table.remove(selectedValues, selectedListIndex) end
                                                        if #selectedValues > 0 then
                                                            local displayText = ""
                                                            for idx, selectedVal in pairs(selectedValues) do
                                                                if next(selectedValues, idx) then
                                                                    displayText = displayText .. optionTextCache[selectedVal] .. ", "
                                                                else
                                                                    displayText = displayText .. optionTextCache[selectedVal]
                                                                end
                                                            end
                                                            optionTextLabel.Text = displayText
                                                        else
                                                            optionTextLabel.Text = placeholderText
                                                            optionTextLabel.TextColor3 = Color3.fromRGB(178, 178, 178)
                                                        end
                                                    end)
                                                end
                                                optionButton.MouseButton1Click:Connect(function()
                                                    local onValueSelected = elementProperties.OnValueSelected
                                                    local onValueUnselected = elementProperties.OnValueUnselected
                                                    local onSelectionDifference = elementProperties.OnSelectionDifference
                                                    local onSelectionChanged = elementProperties.OnSelectionChanged

                                                    onValueSelected = typeof(onValueSelected) == "function" and onValueSelected or nil
                                                    onValueUnselected = typeof(onValueUnselected) == "function" and onValueUnselected or nil
                                                    onSelectionDifference = typeof(onSelectionDifference) == "function" and onSelectionDifference or nil
                                                    onSelectionChanged = typeof(onSelectionChanged) == "function" and onSelectionChanged or nil

                                                    if elementProperties.MultiSelect then
                                                        local selectedIndex = table.find(selectedValues, val)
                                                        if selectedIndex then
                                                            deactivateTween:Play()
                                                            table.remove(selectedValues, selectedIndex)
                                                            if onValueUnselected then coroutine.resume(coroutine.create(onValueUnselected), val) end
                                                            if onSelectionDifference then coroutine.resume(coroutine.create(onSelectionDifference), nil, val) end
                                                        else
                                                            activateTween:Play()
                                                            table.insert(selectedValues, val)
                                                            if onValueSelected then coroutine.resume(coroutine.create(onValueSelected), val) end
                                                            if onSelectionDifference then coroutine.resume(coroutine.create(onSelectionDifference), val, nil) end
                                                        end
                                                        if onSelectionChanged then coroutine.resume(coroutine.create(onSelectionChanged), selectedValues) end
                                                    else -- Single select
                                                        local previouslySelected
                                                        local removedItems = {}
                                                        for _, currentSelectedValue in pairs(selectedValues) do
                                                            if val ~= currentSelectedValue then
                                                                deactivateOptionTweens[currentSelectedValue]:Play()
                                                                previouslySelected = true
                                                                table.insert(removedItems, currentSelectedValue)
                                                            end
                                                        end
                                                        local selectedIndex = table.find(selectedValues, val)
                                                        if selectedIndex then
                                                            if not (elementProperties.SelectionLocks or elementProperties.SelectionForced) then
                                                                deactivateTween:Play()
                                                                table.clear(selectedValues)
                                                                if onSelectionChanged then coroutine.resume(coroutine.create(onSelectionChanged), selectedValues) end
                                                                if onValueUnselected then coroutine.resume(coroutine.create(onValueUnselected), val) end
                                                                if previouslySelected then
                                                                    for _, removedVal in pairs(removedItems) do if onValueUnselected then coroutine.resume(coroutine.create(onValueUnselected), removedVal) end end
                                                                    for _, removedVal in pairs(removedItems) do if onSelectionDifference then coroutine.resume(coroutine.create(onSelectionDifference), nil, removedVal) end end
                                                                end
                                                                if onSelectionDifference then coroutine.resume(coroutine.create(onSelectionDifference), nil, val) end
                                                            else
                                                                if previouslySelected then
                                                                    for _, removedVal in pairs(removedItems) do if onValueUnselected then coroutine.resume(coroutine.create(onValueUnselected), removedVal) end end
                                                                    for _, removedVal in pairs(removedItems) do if onSelectionDifference then coroutine.resume(coroutine.create(onSelectionDifference), nil, removedVal) end end
                                                                end
                                                            end
                                                        else
                                                            activateTween:Play()
                                                            table.clear(selectedValues)
                                                            selectedValues[1] = val
                                                            if onSelectionChanged then coroutine.resume(coroutine.create(onSelectionChanged), selectedValues) end
                                                            if onValueSelected then coroutine.resume(coroutine.create(onValueSelected), val) end
                                                            if previouslySelected then
                                                                for _, removedVal in pairs(removedItems) do if onValueUnselected then coroutine.resume(coroutine.create(onValueUnselected), removedVal) end end
                                                                for _, removedVal in pairs(removedItems) do if onSelectionDifference then coroutine.resume(coroutine.create(onSelectionDifference), val, removedVal) end end
                                                            else
                                                                if onSelectionDifference then coroutine.resume(coroutine.create(onSelectionDifference), val, nil) end
                                                            end
                                                        end
                                                    end

                                                    if #selectedValues > 0 then
                                                        local displayText = ""
                                                        for idx, selectedVal in pairs(selectedValues) do
                                                            if next(selectedValues, idx) then
                                                                displayText = displayText .. optionTextCache[selectedVal] .. ", "
                                                            else
                                                                displayText = displayText .. optionTextCache[selectedVal]
                                                            end
                                                        end
                                                        optionTextLabel.Text = displayText
                                                        optionTextLabel.TextColor3 = Color3.new(1, 1, 1)
                                                    else
                                                        optionTextLabel.Text = placeholderText
                                                        optionTextLabel.TextColor3 = Color3.fromRGB(178, 178, 178)
                                                    end
                                                    dropdownCurrentlyEnabled = optionButton -- Store the clicked button
                                                end)
                                                valueToOptionButton[optionButton] = val
                                            end

                                            if #selectedValues > 0 then
                                                local displayText = ""
                                                for idx, selectedVal in pairs(selectedValues) do
                                                    if next(selectedValues, idx) then
                                                        displayText = displayText .. optionTextCache[selectedVal] .. ", "
                                                    else
                                                        displayText = displayText .. optionTextCache[selectedVal]
                                                    end
                                                end
                                                optionTextLabel.Text = displayText
                                                optionTextLabel.TextColor3 = Color3.new(1, 1, 1)
                                            else
                                                optionTextLabel.Text = placeholderText
                                                optionTextLabel.TextColor3 = Color3.fromRGB(178, 178, 178)
                                            end
                                        end

                                        function elementProperties.RemoveValues(_, valuesToRemove) end -- Empty function in original
                                        function elementProperties.AddSelection(_, selectionToAdd) end -- Empty function in original
                                        function elementProperties.SetSelection(_, newSelection) elementProperties:SetValues(elementProperties.Values, newSelection) end
                                        function elementProperties.RemoveSelection(_, selectionToRemove) end -- Empty function in original

                                        elementProperties:SetValues(elementProperties.Values, {})
                                        elementProperties:SetValues(elementProperties.Values, elementProperties.Selected)
                                        elementProperties.Selected = nil
                                        dropdownCurrentlyEnabled = true -- Flag to allow OnSelectionChanged to fire after initial setup

                                        local showDropdownTween = tweenService:Create(elementInstance.Base.DropDownContainer.List, TweenInfo.new(0.5), { Size = UDim2.new(1, 0, 0, 150) })
                                        local hideDropdownTween = tweenService:Create(elementInstance.Base.DropDownContainer.List, TweenInfo.new(0.5), { Size = UDim2.fromScale(1) })
                                        local rotateArrowDownTween = tweenService:Create(elementInstance.Base.DropDownContainer.Label.Arrow.Clip, TweenInfo.new(0.5), { Position = UDim2.fromOffset(), AnchorPoint = Vector2.zero })
                                        local rotateArrowUpTween = tweenService:Create(elementInstance.Base.DropDownContainer.Label.Arrow.Clip, TweenInfo.new(0.5), { Position = UDim2.fromScale(0, 1), AnchorPoint = Vector2.yAxis })

                                        elementInstance.Base.DropDownContainer.MouseButton1Click:Connect(function()
                                            isDropdownOpen = not isDropdownOpen
                                            if isDropdownOpen then
                                                elementInstance.Base.DropDownContainer.List.Visible = true
                                                showDropdownTween:Play()
                                                rotateArrowDownTween:Play()
                                            else
                                                hideDropdownTween:Play()
                                                rotateArrowUpTween:Play()
                                                hideDropdownTween.Completed:Once(function(_, playbackState)
                                                    if playbackState == Enum.PlaybackState.Completed then
                                                        elementInstance.Base.DropDownContainer.List.Visible = false
                                                    end
                                                end)
                                            end
                                        end)

                                    elseif elementType == "ColorPicker" then
                                        local colorPreviewButton = elementInstance.Base.Color
                                        local initialColor = elementProperties.Value
                                        if typeof(initialColor) == "Color3" then
                                        elseif typeof(initialColor) == "BrickColor" then
                                            initialColor = initialColor.Color
                                        elseif typeof(initialColor) == "string" then
                                            local success, c = pcall(Color3.fromHex, initialColor)
                                            initialColor = success and c or Color3.new()
                                        else
                                            initialColor = Color3.new()
                                        end
                                        colorPreviewButton.BackgroundColor3 = initialColor
                                        elementProperties.Value = initialColor

                                        local function openColorPicker()
                                            colorPickerTargetButton = elementInstance.Base.Color
                                            selectedColor = elementProperties.Value
                                            targetColorPropertyObject = elementProperties
                                            colorPickerWidget.Size = UDim2.fromOffset(384, 384) -- Reset size to basic
                                            basicColorPickerPanel.Visible = true
                                            advancedColorPickerPanel.Visible = false
                                            colorPickerSubtitleLabel.Text = "Basic Colors"

                                            resourcesFolder.Tweens.ColorPickerOpen:Play()
                                            resourcesFolder.Tweens.ColorModalShadeFadeIn:Play()
                                            activeModalCount = activeModalCount + 1
                                            windowSurfaceGui.Window.Content.Interactable = false

                                            -- Convert to HSV for display in Advanced tab
                                            local r = math.floor(selectedColor.R * 255)
                                            local g = math.floor(selectedColor.G * 255)
                                            local b = math.floor(selectedColor.B * 255)
                                            local maxVal, minVal = math.max(r, g, b), math.min(r, g, b)
                                            local h, s, v
                                            v = maxVal
                                            local delta = maxVal - minVal
                                            if maxVal == 0 then s = 0 else s = (delta * 255) / maxVal end
                                            if maxVal == minVal then
                                                h = 0
                                            else
                                                if maxVal == r then
                                                    h = ((g - b) * 60) / delta
                                                    if g < b then h = h + 360 end
                                                elseif maxVal == g then
                                                    h = ((b - r) * 60) / delta + 120
                                                elseif maxVal == b then
                                                    h = ((r - g) * 60) / delta + 240
                                                end
                                            end
                                            hsvHue, hsvSaturation, hsvValue = h / 360, s / 255, v / 255

                                            local hexColor = selectedColor:ToHex()
                                            fineTuneValueTextBoxes.R.TextBox.Text = r
                                            fineTuneValueTextBoxes.G.TextBox.Text = g
                                            fineTuneValueTextBoxes.B.TextBox.Text = b
                                            fineTuneValueTextBoxes.Hex.TextBox.Text = "#" .. hexColor
                                            fineTuneValueTextBoxes.Hue.TextBox.Text = math.floor(h)
                                            fineTuneValueTextBoxes.Sat.TextBox.Text = math.round(s)
                                            fineTuneValueTextBoxes.Val.TextBox.Text = math.round(v)

                                            fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.R.TextBox] = fineTuneValueTextBoxes.R.TextBox.Text
                                            fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.G.TextBox] = fineTuneValueTextBoxes.G.TextBox.Text
                                            fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.B.TextBox] = fineTuneValueTextBoxes.B.TextBox.Text
                                            fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.Hex.TextBox] = fineTuneValueTextBoxes.Hex.TextBox.Text
                                            fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.Hue.TextBox] = fineTuneValueTextBoxes.Hue.TextBox.Text
                                            fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.Sat.TextBox] = fineTuneValueTextBoxes.Sat.TextBox.Text
                                            fineTuneTextBoxCurrentValues[fineTuneValueTextBoxes.Val.TextBox] = fineTuneValueTextBoxes.Val.TextBox.Text

                                            hueCursor.Position = UDim2.fromScale(1 - h / 359, 1 - hsvSaturation)
                                            valueArrow.Position = UDim2.fromScale(0, 1 - hsvValue)
                                            colorPreviewSwatch.BackgroundColor3 = selectedColor
                                            valueLightnessPad.BackgroundColor3 = Color3.fromHSV(hsvHue, hsvSaturation, 1)
                                        end
                                        elementInstance.ClickArea.MouseButton1Click:Connect(openColorPicker)

                                        function elementProperties.SetValue(_, newColor)
                                            local oldColor = elementProperties.Value
                                            if typeof(newColor) == "Color3" then
                                            elseif typeof(newColor) == "BrickColor" then
                                                newColor = newColor.Color
                                            elseif typeof(newColor) == "string" then
                                                local success, c = pcall(Color3.fromHex, newColor)
                                                newColor = success and c or Color3.new()
                                            else
                                                newColor = Color3.new()
                                            end
                                            if oldColor ~= newColor then
                                                colorPreviewButton.BackgroundColor3 = newColor
                                                elementProperties.Value = newColor
                                                local onChangedCallback = elementProperties.OnChanged
                                                if typeof(onChangedCallback) == "function" then
                                                    coroutine.resume(coroutine.create(onChangedCallback), newColor, 0)
                                                end
                                            end
                                        end
                                        elementProperties.Open = openColorPicker

                                    elseif elementType == "Button" then
                                        local buttonText = elementProperties.Text
                                        if buttonText == nil or elementProperties.Simple then
                                            elementProperties.Simple = true
                                            elementInstance.Base.Button:Destroy()
                                            elementInstance.Base.UIPadding:Destroy()
                                            resourcesFolder.Components.ButtonArrow:Clone().Parent = elementInstance.Base
                                            elementInstance.Size = UDim2.fromOffset(60, 60)
                                            function elementProperties.SetText(_, text) end -- Empty function for simple buttons
                                        else
                                            local label = elementInstance.Base.Button.Label
                                            buttonText = buttonText and tostring(buttonText) or "Button"
                                            label.Text = buttonText
                                            elementProperties.Text = buttonText
                                            function elementProperties.SetText(_, text)
                                                text = tostring(text)
                                                label.Text = text
                                                elementProperties.Text = text
                                            end
                                        end
                                        elementProperties.Click = elementInstance.ClickArea.MouseButton1Click

                                    elseif elementType == "Slider" then
                                        local sliderBase = elementInstance.Base
                                        local sliderKnob = sliderBase.Track.InnerTrack.Knob
                                        local sliderFill = sliderBase.Track.Fill
                                        local minRange = tonumber(elementProperties.Min) or 0
                                        local maxRange = tonumber(elementProperties.Max) or 100
                                        local initialValue = tonumber(elementProperties.Value) or (maxRange < minRange and minRange or minRange + (maxRange - minRange) / 2)
                                        local stepValue = tonumber(elementProperties.Step)
                                        local isPercentDisplay = not not elementProperties.IsPercent
                                        stepValue = stepValue and 1 / stepValue or 1

                                        local normalizedValue = (initialValue - minRange) / (maxRange - minRange)
                                        normalizedValue = math.clamp(normalizedValue, 0, 1)

                                        local displayedValue
                                        if stepValue ~= math.huge and stepValue ~= -math.huge then
                                            local valueRange = (maxRange - minRange)
                                            displayedValue = math.round((minRange + (normalizedValue * valueRange)) * stepValue) / stepValue
                                            local scaledFill = UDim2.fromScale((displayedValue - minRange) / valueRange, 1)
                                            sliderKnob.Position = scaledFill
                                            sliderFill.Size = scaledFill
                                            displayedValue = 1 / displayedValue ~= -math.huge and displayedValue or 0 -- Handle possible -inf
                                        else
                                            displayedValue = minRange + (normalizedValue * (maxRange - minRange))
                                            sliderKnob.Position = UDim2.fromScale(normalizedValue, 0.5)
                                            sliderFill.Size = UDim2.fromScale(normalizedValue, 1)
                                        end
                                        displayedValue = math.clamp(displayedValue, minRange, maxRange)

                                        elementProperties.Min = minRange
                                        elementProperties.Max = maxRange
                                        elementProperties.Value = displayedValue
                                        elementProperties.Step = stepValue
                                        elementProperties.IsPercent = isPercentDisplay

                                        sliderKnob.MouseEnter:Connect(function()
                                            if (not activeSliderKnob) or activeSliderKnob == sliderKnob then
                                                currentTooltipElement = sliderKnob
                                                tooltipTextLabel.Text = isPercentDisplay and math.round(100 * elementProperties.Value) .. "%" or elementProperties.Value
                                                updateTooltipPosition(sliderBase.AbsolutePosition, sliderBase.AbsoluteSize, 3)
                                            end
                                        end)
                                        sliderKnob.MouseLeave:Connect(function()
                                            if currentTooltipElement == sliderKnob and not activeSliderKnob then
                                                hideTooltipTween:Play()
                                            end
                                            currentTooltipElement = nil
                                        end)
                                        sliderKnob.MouseButton1Down:Connect(function()
                                            sliderKnobInitialPosition = sliderKnob.Position
                                            activeSliderKnob = sliderKnob
                                            sliderFillBar = sliderFill
                                            currentSliderValueObject = elementProperties
                                            sliderLiveValue = elementProperties.Value
                                            sliderMinValue = minRange
                                            sliderMaxValue = maxRange
                                            sliderStepValue = stepValue
                                            isSliderPercentDisplay = not isPercentDisplay -- Re-using isSliderPercentDisplay for this local function only (e is the boolean)
                                            tooltipTextLabel.Text = isPercentDisplay and math.round(100 * elementProperties.Value) .. "%" or elementProperties.Value
                                            updateTooltipPosition(sliderBase.AbsolutePosition, sliderBase.AbsoluteSize, 3)
                                        end)

                                        function elementProperties.SetValue(_, valueToSet)
                                            valueToSet = tonumber(valueToSet) or (maxRange < minRange and minRange or minRange + (maxRange - minRange) / 2)
                                            local valueRange = (maxRange - minRange)
                                            local newNormalizedValue = (valueToSet - minRange) / valueRange
                                            newNormalizedValue = math.clamp(newNormalizedValue, 0, 1)

                                            local actualValue
                                            if stepValue ~= math.huge and stepValue ~= -math.huge then
                                                local steppedValueRange = (maxRange - minRange)
                                                actualValue = math.round((minRange + (newNormalizedValue * steppedValueRange)) * stepValue) / stepValue
                                                local scaledFill = UDim2.fromScale((actualValue - minRange) / steppedValueRange, 1)
                                                sliderKnob.Position = scaledFill
                                                sliderFill.Size = scaledFill
                                                actualValue = 1 / actualValue ~= -math.huge and actualValue or 0
                                            else
                                                actualValue = minRange + (newNormalizedValue * (maxRange - minRange))
                                                local scaledFill = UDim2.fromScale(newNormalizedValue, 1)
                                                sliderKnob.Position = scaledFill
                                                sliderFill.Size = scaledFill
                                            end
                                            actualValue = math.clamp(actualValue, minRange, maxRange)

                                            if currentSliderValueObject == elementProperties then
                                                tooltipTextLabel.Text = isPercentDisplay and math.round(100 * actualValue) .. "%" or actualValue
                                                local tooltipCurrentSize = tooltipTextBubble.AbsoluteSize
                                                tooltipContainer.Size = UDim2.fromOffset(tooltipCurrentSize.X, tooltipCurrentSize.Y)
                                                sliderLiveValue = actualValue
                                            end
                                            local oldValue = elementProperties.Value
                                            elementProperties.Value = actualValue
                                            if oldValue ~= actualValue then
                                                local onChangedCallback = elementProperties.OnChanged
                                                if typeof(onChangedCallback) == "function" then
                                                    coroutine.resume(coroutine.create(onChangedCallback), actualValue)
                                                end
                                            end
                                        end

                                        function elementProperties.SetValueFromPercent(elementApi, percentValue)
                                            percentValue = tonumber(percentValue) or (maxRange < minRange and 1 or 0.5)
                                            local valueRange = (maxRange - minRange)
                                            percentValue = math.clamp(percentValue, 0, 1)

                                            local actualValue
                                            if stepValue ~= math.huge and stepValue ~= -math.huge then
                                                local steppedValueRange = (maxRange - minRange)
                                                actualValue = math.round((minRange + (percentValue * steppedValueRange)) * stepValue) / stepValue
                                                local scaledFill = UDim2.fromScale((actualValue - minRange) / steppedValueRange, 1)
                                                sliderKnob.Position = scaledFill
                                                sliderFill.Size = scaledFill
                                                actualValue = 1 / actualValue ~= -math.huge and actualValue or 0
                                            else
                                                actualValue = minRange + (percentValue * (maxRange - minRange))
                                                local scaledFill = UDim2.fromScale(percentValue, 1)
                                                sliderKnob.Position = scaledFill
                                                sliderFill.Size = scaledFill
                                            end
                                            actualValue = math.clamp(actualValue, sliderMinValue, sliderMaxValue)

                                            if currentSliderValueObject == elementApi then
                                                tooltipTextLabel.Text = isPercentDisplay and math.round(100 * actualValue) .. "%" or actualValue
                                                local tooltipCurrentSize = tooltipTextBubble.AbsoluteSize
                                                tooltipContainer.Size = UDim2.fromOffset(tooltipCurrentSize.X, tooltipCurrentSize.Y)
                                                sliderLiveValue = actualValue
                                            end
                                            local oldValue = elementProperties.Value
                                            elementProperties.Value = actualValue
                                            if oldValue ~= actualValue then
                                                local onChangedCallback = elementProperties.OnChanged
                                                if typeof(onChangedCallback) == "function" then
                                                    coroutine.resume(coroutine.create(onChangedCallback), actualValue)
                                                end
                                            end
                                            return actualValue
                                        end
                                        function elementProperties.SetMin(_, min) end
                                        function elementProperties.SetMax(_, max) end
                                        function elementProperties.SetStep(_, step) end

                                    elseif elementType == "TextBox" then
                                        local textBoxWidget = elementInstance.Base.TextBox
                                        local initialValue = elementProperties.Value
                                        initialValue = initialValue and tostring(initialValue) or ""
                                        elementProperties.Value = initialValue
                                        textBoxWidget.Text = initialValue
                                        local cachedText = initialValue
                                        local placeholderText = elementProperties.PlaceholderText
                                        placeholderText = placeholderText and tostring(placeholderText) or ""
                                        elementProperties.PlaceholderText = placeholderText
                                        textBoxWidget.PlaceholderText = placeholderText

                                        textBoxWidget:GetPropertyChangedSignal("Text"):Connect(function()
                                            local newText = textBoxWidget.Text
                                            elementProperties.Value = newText
                                            local onChangedCallback = elementProperties.OnChanged
                                            onChangedCallback = typeof(onChangedCallback) == "function" and onChangedCallback or nil
                                            if elementProperties.Numeric then
                                                if tonumber(newText) then
                                                    if newText ~= "" then
                                                        if onChangedCallback and newText ~= cachedText then coroutine.resume(coroutine.create(onChangedCallback), newText) end
                                                        cachedText = newText
                                                    end
                                                else
                                                    if newText ~= "" then textBoxWidget.Text = cachedText end
                                                end
                                            else
                                                if onChangedCallback and newText ~= cachedText then coroutine.resume(coroutine.create(onChangedCallback), newText) end
                                                cachedText = newText
                                            end
                                        end)

                                        function elementProperties.SetValue(_, value)
                                            textBoxWidget.Text = value
                                            elementProperties.Value = value
                                            local newText = textBoxWidget.Text
                                            elementProperties.Value = newText
                                            local onChangedCallback = elementProperties.OnChanged
                                            onChangedCallback = typeof(onChangedCallback) == "function" and onChangedCallback or nil
                                            if elementProperties.Numeric then
                                                if tonumber(newText) then
                                                    if newText ~= "" then
                                                        if onChangedCallback and newText ~= cachedText then coroutine.resume(coroutine.create(onChangedCallback), newText) end
                                                        cachedText = newText
                                                    end
                                                else
                                                    if newText ~= "" then textBoxWidget.Text = cachedText end
                                                end
                                            else
                                                if onChangedCallback and newText ~= cachedText then coroutine.resume(coroutine.create(onChangedCallback), newText) end
                                                cachedText = newText
                                            end
                                        end
                                        function elementProperties.SetPlaceholderText(_, text)
                                            textBoxWidget.PlaceholderText = text
                                            elementProperties.PlaceholderText = text
                                        end
                                        elementProperties.Focused = textBoxWidget.Focused
                                        elementProperties.FocusLost = textBoxWidget.FocusLost
                                    end
                                end
                                elementProperties.Destroy = function() elementInstance:Destroy() end

                                if not sectionApi.PageSection then
                                    elementInstance.Parent = sectionApi.Object.ListBase
                                else
                                    elementInstance.Parent = sectionApi.Object
                                end
                                return elementProperties
                            end
                        }
                    end
                }

            local dummySection = pageApi:CreateSection("", nil, true)
            dummySection.Object:Destroy()
            dummySection.Object = pageFrame
            dummySection.PageSection = true
            pageApi.Section = dummySection
            pageApi.CreateElement = function(pageContext, elementType, elementProperties) return pageContext.Section:CreateElement(elementType, elementProperties) end
            pageApi.CreateSeparator = function(pageContext) return pageContext.Section:CreateSeparator() end
            return pageApi
        end,
        FocusTab = function(_, tabTitle) end, -- Empty function in original
        DestroyTab = function(_, tabTitle) end, -- Empty function in original
    },
    ShowToast = function(_, toastOptions)
        if typeof(toastOptions) == "table" then
            local duration = (tonumber(toastOptions.Duration) or 5)
            if duration < 1 then duration = 1 end
            local toastFrame = resourcesFolder.Components.Toast:Clone()
            local toastTypeIndex = tonumber(toastOptions.Type)
            local toastTypeName = dialogTypeNames[toastTypeIndex]
            toastDurations[toastFrame] = duration
            local openToastFunction -- Forward declaration for recursive call

            toastFrame.Parent = playerScreenGui.ToastsFrame
            if toastTypeName then
                toastFrame.BackgroundColor3 = resourcesFolder.Styles.Toasts[toastTypeName].BgColor.Value
                resourcesFolder.Icons.Alerts[toastTypeName]:Clone().Parent = toastFrame.Inner.Icon
            else
                toastFrame.Inner.Icon.Visible = false
            end
            if toastOptions.Transparent == false then toastFrame.BackgroundTransparency = 0 end

            local toastTitle = toastOptions.Title
            local toastText = toastOptions.Text
            local buttons = toastOptions.Buttons

            tweenService:Create(toastFrame, TweenInfo.new(0.25, Enum.EasingStyle.Linear), { AnchorPoint = Vector2.yAxis }) -- Initial position for stack animation

            if toastTitle ~= nil then toastFrame.Inner.ToastTitle.Text = tostring(toastTitle) end
            if toastText ~= nil then toastFrame.Inner.ToastText.Text = tostring(toastText) end

            local toastSpacing = 10
            local maxToastsHeight = playerScreenGui.ToastsFrame.AbsoluteSize.Y

            local function rearrangeToasts()
                local currentOffset = 0
                for _, activeToast in next, activeToastsList do
                    tweenService:Create(activeToast, TweenInfo.new(0.25), { Position = UDim2.new(1, 0, 1, -currentOffset) }):Play()
                    currentOffset = currentOffset + (activeToast.AbsoluteSize.Y + toastSpacing)
                end
            end

            local function processToastQueue()
                local _, nextQueuedToast = next(toastShowQueue)
                if #activeToastsList == 0 then
                    if nextQueuedToast then openToastFunction(nextQueuedToast) end
                else
                    local currentActiveHeight = -toastSpacing
                    for _, activeToast in next, activeToastsList do
                        currentActiveHeight = currentActiveHeight + (activeToast.AbsoluteSize.Y + toastSpacing)
                    end
                    for _, queuedToast in next, toastShowQueue do
                        if currentActiveHeight + queuedToast.AbsoluteSize.Y + toastSpacing <= maxToastsHeight then
                            openToastFunction(queuedToast)
                            currentActiveHeight = currentActiveHeight + (queuedToast.AbsoluteSize.Y + toastSpacing)
                        else
                            break
                        end
                    end
                end
            end

            local function onToastDestroy(toastFrameToDestroy, tween)
                if tween.PlaybackState ~= Enum.PlaybackState.Cancelled then
                    toastFrameToDestroy:Destroy()
                    tween:Destroy()
                    table.remove(activeToastsList, table.find(activeToastsList, toastFrameToDestroy))
                    toastDurations[toastFrameToDestroy] = nil
                    rearrangeToasts()
                    processToastQueue()
                end
            end

            local function closeToast(toastFrameToClose)
                for _, child in pairs(toastFrameToClose:GetChildren()) do
                    if child:IsA("GuiButton") then child.Interactable = false end
                end
                if toastApiObjects[toastFrameToClose] then toastApiObjects[toastFrameToClose].Closed = true end
                toastFrameToClose.AnchorPoint = Vector2.one
                local hideTween = tweenService:Create(toastFrameToClose, TweenInfo.new(0.25, Enum.EasingStyle.Linear), { AnchorPoint = Vector2.yAxis })
                hideTween.Completed:Once(function() onToastDestroy(toastFrameToClose, hideTween) end)
                hideTween:Play()
            end

            toastApiObjects[toastFrame] = {
                __ToastFrame = toastFrame,
                Open = function() end, -- This seems to be an empty stub in the original
                Close = function(toastApi) closeToast(toastApi.__ToastFrame) end,
                Title = toastFrame.Inner.ToastTitle,
                SubContentLabel = toastFrame.Inner.ToastText,
                CloseButton = toastFrame.Inner.CloseButton,
                Closed = false
            }

            if typeof(buttons) == "table" then
                for _, buttonOptions in next, buttons do
                    if typeof(buttonOptions) == "table" then
                        local button = resourcesFolder.Components.ToastButton:Clone()
                        if toastTypeName then
                            button.BackgroundColor3 = Color3.new(1, 1, 1)
                            button.ButtonText.TextColor3 = Color3.fromRGB(33, 33, 33)
                        end
                        local title = buttonOptions.Title
                        local callback = buttonOptions.Callback
                        if title then button.ButtonText.Text = tostring(title) end
                        button.MouseButton1Click:Connect(function()
                            if typeof(callback) == "function" then
                                coroutine.resume(coroutine.create(callback), title, _, toastOptions.Nonce)
                            end
                            if not (toastOptions.CloseWhenButtonClicked == false) then closeToast(toastFrame) end
                        end)
                        button.Parent = toastFrame.Inner
                    end
                end
            end

            if toastOptions.CloseButtonVisible == false then
                toastFrame.Inner.CloseButton.Visible = false
            else
                toastFrame.Inner.CloseButton.MouseButton1Click:Once(function() closeToast(toastFrame) end)
            end

            openToastFunction = function(toastToShow)
                local currentDuration = toastDurations[toastToShow]
                table.remove(toastShowQueue, table.find(toastShowQueue, toastToShow))
                table.insert(activeToastsList, 1, toastToShow)
                rearrangeToasts()
                local autoCloseTween = tweenService:Create(toastToShow, TweenInfo.new(currentDuration * 0.5, Enum.EasingStyle.Linear, Enum.EasingDirection.Out, 0, true), { AnchorPoint = Vector2.new(currentDuration * 2, 1) })
                autoCloseTween.Completed:Once(function() onToastDestroy(toastToShow, autoCloseTween) end)
                autoCloseTween:Play()
                tweenService:Create(toastToShow.ProgressBar.ProgressValue, TweenInfo.new(currentDuration, Enum.EasingStyle.Linear), { Size = UDim2.fromScale(1, 4) }):Play()
            end

            table.insert(toastShowQueue, toastFrame)
            processToastQueue()
            return toastApiObjects[toastFrame]
        else
            local function noop() end
            return { Open = noop, Close = noop }
        end
    end,
    SetFluentTranslationHack = function() end, -- Empty function in original
    Destroying = resourcesFolder.Bindables.HubDestroying.Event
}

-- Setup default "Settings" page content
do
    local transparencyValue = 0.25
    local isBackgroundTransparent = true
    local settingsPage = publicApiTable.Hub:CreatePage("Settings", "cog")
    settingsPage.TabInstance:Destroy() -- Remove the navigation tab generated for settings, as it's directly accessible
    settingsPage.Instance.Parent = windowSurfaceGui.Window.Content.Hub.MainContent.PageView.Settings.PageBase.PageContents -- Reparent the page content

    local appearanceSection = settingsPage:CreateSection("Appearance")
    appearanceSection:CreateElement("Toggle", {
        Value = true,
        Label = { Title = "Transparent Background", Text = "Enables UI background transparency." },
        OnChanged = function(value)
            if value then
                hubBackground.GroupTransparency = transparencyValue
                isBackgroundTransparent = true
            else
                hubBackground.GroupTransparency = 0
                isBackgroundTransparent = false
            end
        end
    })
    appearanceSection:CreateElement("Slider", {
        Value = 0.25,
        Min = 0,
        Max = 0.25,
        Step = 0.01,
        IsPercent = true,
        Label = { Title = "UI Transparency", Text = "Controls how transparent the UI background is. This setting only applies if the \"Transparent Background\" setting is turned on." },
        OnChanged = function(value)
            transparencyValue = value
            if isBackgroundTransparent then
                hubBackground.GroupTransparency = transparencyValue
            end
        end
    })

    isFirstPageInHub = true -- Reset this flag, as settings page is handled separately from navbuttons.
    activeTabButton = nil
    activeTabPage = nil
end

return publicApiTable
